# タスク1.3の実装記録

## タスク概要
GitHub Issue #21 タスクグループ1.3「3方向マージエンジンとコンフリクト検出」の実装

## 実装内容

### タスク1.3.1: DiffEngineモジュール
- `DiffEngine`クラスを実装
- `node-diff3`ライブラリを使用した3方向マージ機能を実装
- コンフリクトマーカーの挿入処理を実装

### タスク1.3.2: コンフリクト検出と報告
- `ConflictReporter`クラスを実装
- コンフリクトレポートの生成機能を実装
- ヘルプメッセージとエラーメッセージの生成機能を実装

## 新規作成したファイル

### 1. packages/cli/src/lib/sync/diff-engine.ts
3方向マージエンジンの実装。主要メソッド：
- `merge3Way(base, local, template)`: 3方向マージを実行
- `hasConflictMarkers(content)`: コンフリクトマーカーの存在確認
- `parseConflictMarkers(content)`: コンフリクトマーカーのパース

### 2. packages/cli/src/lib/sync/diff-engine.test.ts
DiffEngineクラスのテスト実装。11のテストケースを作成：
- ローカルのみ変更
- テンプレートのみ変更
- 異なる行の両方変更（自動マージ）
- 同じ行の両方変更（コンフリクト）
- 複数のコンフリクト
- コンフリクトマーカーの検出とパース

### 3. packages/cli/src/lib/sync/conflict-reporter.ts
コンフリクト報告クラスの実装。主要メソッド：
- `createReport(fileConflicts)`: コンフリクトレポート作成
- `formatReport(report)`: レポートのフォーマット
- `formatHelpMessage()`: ヘルプメッセージ生成
- `hasUnresolvedConflicts(content)`: 未解決コンフリクト検出
- `formatUnresolvedConflictError(filePath)`: エラーメッセージ生成
- `formatExitMessage(report)`: 終了メッセージ生成

### 4. packages/cli/src/lib/sync/conflict-reporter.test.ts
ConflictReporterクラスのテスト実装。9のテストケースを作成：
- レポート作成
- レポートフォーマット
- ヘルプメッセージ生成
- 未解決コンフリクト検出
- エラーメッセージ生成
- 終了メッセージ生成

## 編集したファイル

### 1. packages/cli/src/types/sync.ts
型定義を追加：
- `Conflict`: コンフリクト情報（line, localContent, templateContent）
- `MergeResult`: マージ結果（success, content, conflicts）

### 2. packages/cli/package.json
依存関係を追加：
- `node-diff3 ^3.2.0`

## 実装メモ

### 使用した技術
- **node-diff3**: 3方向マージライブラリ
- **TypeScript**: strict mode準拠
- **Vitest**: テストフレームワーク

### 重要な決定事項

1. **コンフリクトマーカー形式**
   ```
   <<<<<<< LOCAL (your changes)
   ローカルの内容
   =======
   テンプレートの内容
   >>>>>>> TEMPLATE (from @einja/cli)
   ```

2. **3方向マージアルゴリズム**
   - ローカルのみ変更 → ローカルを採用
   - テンプレートのみ変更 → テンプレートを採用
   - 異なる行を両方変更 → 自動マージ
   - 同じ行を両方変更 → コンフリクトマーカー挿入

3. **型安全性**
   - `node-diff3`の戻り値に対して型ガードを追加
   - `chunk.ok`と`chunk.conflict`の存在確認を厳格に実施

4. **エラーハンドリング**
   - コンフリクト発生時は部分的成功として扱う
   - 未解決コンフリクトの再実行時は明確なエラーメッセージを表示

### テスト結果
- 全42テスト成功（DiffEngine: 11、ConflictReporter: 9、その他: 22）
- Lintエラー: 0
- TypeScriptエラー: 0

## 受け入れ基準の達成状況

### AC7.1: コンフリクトマーカーの挿入
✅ 達成
- DiffEngineでコンフリクトマーカーを正しく挿入
- フォーマット: `<<<<<<< LOCAL`, `=======`, `>>>>>>> TEMPLATE`

### AC7.2: コンフリクト発生時のエラー終了
✅ 達成（実装準備完了）
- ConflictReporterで終了コード1に対応する仕組みを実装
- コンフリクト解消方法のヘルプメッセージを生成

### AC7.3: 未解決コンフリクトの検出
✅ 達成
- `hasUnresolvedConflicts()`で未解決コンフリクトを検出
- 再実行時のエラーメッセージを生成

## 次のステップ
- タスク1.4: MarkerProcessorの実装（@einja:managedマーカー処理）
- タスク1.5: BackupManagerの実装（バックアップ機能）
