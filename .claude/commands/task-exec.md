---
description: "GitHub Issueのタスクグループを実行するコマンド。ARGUMENTS: Issue番号（必須、#123形式）とタスクグループ番号（必須、1.1形式）"
allowed-tools: Task, Read, Write, Edit, MultiEdit, Bash, Grep, Glob, WebFetch, mcp__github__*, mcp__serena__*
---

# タスク実行コマンド

## 役割

指定されたタスクグループの実装を管理し、QA合格まで自動的にループ実行する。

## 入力の解析

$ARGUMENTSから以下を解析：
- **Issue番号**（必須、例: `#123`、`123`）
- **タスクグループ番号**（必須、例: `1.1`、`2.3`）

どちらかが欠けている場合はユーザーに要求する。

解析した値は、各サブエージェント呼び出し時のpromptに含めて渡す。

## サブエージェント出力の表示ルール

### 🚨 重要: 完全出力の必須要件

各サブエージェント（task-executer、task-reviewer、task-qa、task-modification-analyzer）の呼び出し後、
**Taskツールから返却されたメッセージをそのまま全文出力すること**。

### 具体的な手順

1. Taskツールでサブエージェントを呼び出す
2. Taskツールの結果（サブエージェントの最終出力）を受け取る
3. **その結果をそのままユーザーに表示する**（追加の要約や説明は不要）
4. その後、次のフェーズへの移行メッセージを出力

### ❌ 禁止事項

- サブエージェントの出力を要約すること
- 「実装フェーズが完了しました」のような簡潔なメッセージだけで済ませること
- 出力の一部だけを抜粋すること
- 自分の言葉で言い換えること

### ✅ 正しい出力例

```
[サブエージェントの出力全文をここにそのまま表示]

---
続いてレビューフェーズを実行します。
```

### ❌ 間違った出力例

```
実装フェーズが完了しました。続いてレビューフェーズを実行します。
```
（← サブエージェントの詳細出力が省略されているためNG）

## 処理フロー

```
┌─────────────────────────────────────────────────────────┐
│                    品質保証ループ                        │
│                                                         │
│  task-executer → task-reviewer → task-qa               │
│       ↑              │              │                   │
│       └──────────────┴──────────────┘                   │
│          （MAJOR/テスト失敗時は自動的に戻る）             │
│                                                         │
└─────────────────────────────────────────────────────────┘
                           │
                           ↓ 全テスト合格
                   追加指示待ち状態
                           │
              ┌────────────┴────────────┐
              ↓                         ↓
    ユーザーが追加指示           ユーザーが「終了」
              │                         │
              ↓                         ↓
    task-modification-analyzer      コマンド終了
              │
              ↓ 承諾後
    推奨パターンで実行
              │
              └──→ 追加指示待ち状態に戻る
```

各フェーズ完了後、サブエージェントの出力を表示したら即座に次のフェーズへ進む。ユーザーの応答は待たない。

### 1. 実装フェーズ（task-executer）
- 要件定義・設計書に基づいた実装を実行
- 完了後、出力を表示して即座にレビューフェーズへ

### 2. レビューフェーズ（task-reviewer）
- 要件定義・設計との整合性確認
- MAJOR判定 → 実装フェーズに戻る
- PASS/MINOR判定 → 品質保証フェーズへ

### 3. 品質保証フェーズ（task-qa）
- 受け入れ条件に基づく動作確認
- テスト失敗 → 実装フェーズに戻る
- 全テスト合格 → 追加指示待ち状態へ

---

## 受け入れ条件の参照方法

このセクションは、task-executer、task-reviewer、task-qaサブエージェントが受け入れ条件を参照する際の標準手順を定義します。

### requirements.mdの標準構造

**必須セクション**:
- **受け入れ基準（Acceptance Criteria）**: 各ACが以下の形式で記載

**AC（Acceptance Criteria）の形式**:
```markdown
##### 機能要件
- [ ] Given: 前提条件
      When: 実行する操作
      Then: 期待される結果
```

### task-executerの受け入れ条件参照方法

1. タスクグループの関連ドキュメント（`requirements.md`）を読み込む
2. 各ユーザーストーリー配下の「受け入れ基準」セクションを特定
3. **検証レベルが「Unit」の AC のみ**を実装対象とする
4. 各 AC（Given/When/Then）に対して実装と単体テストを作成
5. `design.md` の技術仕様に準拠した実装を行う

**検証責務**:
- **Unit テスト**: 必須実装、実装と同時に作成
- **Integration/Browser テスト**: 実装不要（task-qa が担当）

**完了条件**:
- 実装したコードの単体テストが全て合格
- 検証レベルが「Unit」の AC を全て満たす
- Integration/Browser レベルの AC は未検証でも実装フェーズ完了とする

> **Note**: 検証レベルの詳細は `docs/steering/terminology.md` を参照してください。

### task-reviewerの受け入れ条件参照方法

1. `requirements.md` の各ユーザーストーリー配下の「受け入れ基準」セクションを参照
2. 実装が各ACを満たしているかを確認
3. ACとの整合性をレビュー観点の最優先項目とする

### task-qaの受け入れ条件参照方法

**⚠️ 最重要**: QAエージェントは以下の手順で受け入れ条件を参照

1. **受け入れ基準の抽出**
   - タスクグループの `requirements.md` を読み込む
   - 各ユーザーストーリー配下の「受け入れ基準」セクションを特定
   - **検証レベルが「Integration」「Browser」の AC のみ**を抽出
   - 検証レベルが「Unit」の AC はスキップ（task-executer が既に検証済み）

2. **テストシナリオの作成**
   - 各 AC に対して、Given/When/Then に基づくテストシナリオを作成
   - Integration: API + DB + ミドルウェアの連携テスト
   - Browser: Playwright MCP を使用したユーザーシナリオテスト
   - QA 仕様書（`qa-tests/phaseN/X-Y.md`）に記録

3. **SUCCESS 判定基準**
   - **検証レベルが「Integration」「Browser」の全ての AC が満たされた場合のみ**、SUCCESS 判定
   - 1つでも AC を満たさない場合、FAILURE 判定して適切な戻し先を決定

> **用語の明確化**: 「E2E」はPlaywrightコードによる自動テスト（`pnpm test:e2e`）を指します。task-qaが実行するPlaywright MCPテストは「Browser」検証レベルです。詳細は `docs/steering/terminology.md` を参照してください。

4. **参照ドキュメント**
   - QA テスト項目作成方針: `docs/steering/acceptance-criteria-and-qa-guide.md`
   - テンプレート: `docs/templates/requirements.md.template`

---

## 失敗時のリカバリーフロー

### 失敗原因の分類

task-qa は以下の基準で失敗原因を分類し、適切な戻し先を決定します：

#### A: 実装ミス（コードロジックの問題）
- **症状**: 期待値と実際の挙動が異なる、エラーが発生
- **戻し先**: task-executer（実装フェーズ）
- **対応**: コード修正 → 再度 reviewer → qa
- **例**: API が 404 を返す、バリデーションが動作しない

#### B: 要件理解の齟齬（要件定義の問題）
- **症状**: 実装は正しいが、要件と一致しない
- **戻し先**: requirements.md 修正 → 再度 task-executer
- **対応**: 要件明確化 + 再実装 → reviewer → qa
- **例**: 想定していなかったエッジケース、曖昧な要件の誤解

#### C: 設計不備（アーキテクチャの問題）
- **症状**: 実装方法が技術的に不適切
- **戻し先**: design.md 修正 → 再度 task-executer
- **対応**: 設計見直し + 再実装 → reviewer → qa
- **例**: パフォーマンス問題、セキュリティ脆弱性

#### D: テスト環境の問題（一時的なエラー）
- **症状**: 実装は正しいが、環境要因で失敗
- **戻し先**: QA 再実行（修正不要）
- **対応**: 環境調整のみ
- **例**: ネットワークタイムアウト、データベース接続エラー

### task-qa の判定ロジック

1. テスト結果を詳細に確認
2. 失敗原因を以下の 4 分類に分類:
   - A: 実装ミス
   - B: 要件理解の齟齬
   - C: 設計不備
   - D: テスト環境の問題
3. 分類に基づいて戻し先を決定
4. 完了報告に分類結果と推奨アクションを明記
5. 分類に応じた戻し先に自動的に進む

---

## QA仕様書の作成・更新フロー

### 初回実行時（qa-tests/phaseN/X-Y.md が存在しない場合）

1. **ファイルの新規作成**
   - タスクグループ番号に基づいて `qa-tests/phaseN/X-Y.md` を新規作成
   - 例: タスクグループ1.1 → `qa-tests/phase1/1-1.md`

2. **受け入れ基準の抽出**
   - `requirements.md` の各ユーザーストーリー配下の「受け入れ基準」セクションから各ACを抽出

3. **テストシナリオの作成**
   - 各ACに対してテストシナリオを作成
   - テンプレート: `docs/steering/acceptance-criteria-and-qa-guide.md` 参照

4. **QA仕様書の構造**:
```markdown
## 機能名: [タスク名]
- 背景/価値: [requirements.mdから抽出]
- 関連 AC: AC1.1, AC1.2, AC2.1
- テスト範囲: Integration / Browser

- シナリオ:
  1. [AC1.1に対応するシナリオ]
     - 前提: [Given]
     - 操作: [When]
     - 期待結果: [Then]
     - ログ/メトリクス確認方法: [確認手段]

### 実施結果（最終更新: YYYY-MM-DD）
**ステータス: [✅ SUCCESS / ❌ FAILURE / ⚠️ PARTIAL]**
```

### 2回目以降の実行時（qa-tests/phaseN/X-Y.md が既に存在する場合）

1. **既存ファイルの読み込み**
   - `qa-tests/phaseN/X-Y.md` を読み込む

2. **更新対象の特定**
   - 「実施結果」セクションのみを更新対象とする
   - シナリオ部分は**保持**（変更しない）

3. **結果の記録**
   - 最新のテスト実施結果を「実施結果」セクションに追記
   - ステータスを更新（SUCCESS / FAILURE / PARTIAL）

---

## 追加指示待ち状態

QA合格後、以下を表示：

```
タスクグループの実装が完了しました。

追加の修正や改善がある場合は指示してください。
完了する場合は「終了」または「完了」と入力してください。
```

### 追加修正の対応（task-modification-analyzer）

ユーザーから追加指示があった場合：
1. task-modification-analyzerを呼び出し（Issue番号、タスクグループ番号、ユーザー指示を渡す）
2. 分析結果を表示してユーザーの承諾を待つ
3. 承諾後、推奨パターンで実行：
   - 小規模修正: task-executerのみ
   - 中規模以上: task-executer → task-reviewer → task-qa
4. 完了後、追加指示待ち状態に戻る

### 終了条件

ユーザーが「終了」「完了」「done」と入力した場合、コマンドを終了。

## 注意事項

- Issue番号とタスクグループ番号の両方が必須
- GitHub Issueのチェックボックス更新は自動では行わない
- コミット時は [コミットルール](../../docs/steering/commit-rules.md) を遵守
