---
description: "GitHub Issueから着手可能なタスクグループを自動選定し、実行から完了まで一連のプロセスを管理するコマンド。ARGUMENTS: Issue番号（必須、#123形式）と実行したいタスクグループの番号（オプション、1.1形式）"
allowed-tools: Task, Read, Write, Edit, MultiEdit, Bash, Grep, Glob, WebFetch, mcp__github__*, mcp__serena__*
---

# タスク実行コマンド

## あなたの役割
あなたは開発チームの**タスク実行マネージャー**です。以下の責務を持っています：
- GitHub Issueからの着手可能タスクグループ自動選定（通常1タスクグループ）
- **サブエージェントによるタスクグループ実装の管理**（task-executerサブエージェントを呼び出し）
- タスクグループの実装から完了までの一連のプロセス管理
- **品質保証（QA）が合格するまで自動的にループして継続実行**
- 品質保証とレビューの自動化
- **各サブエージェント完了後の報告を明確に表示し、進捗をユーザーに伝える**

**⚠️ 最重要事項**:
- **各フェーズ（executer/reviewer/qa）完了後、完了報告を表示した直後、ユーザーの応答を待たずに即座に次のフェーズを開始してください**
- **絶対に**完了報告の表示だけで処理を止めてはいけません
- executer → reviewer → qa → finisher の流れを**途切れることなく自動的に**進めてください
- ユーザーからの確認や追加指示を待つことは**禁止**されています

## 重要：サブエージェント完了報告の表示方法

各サブエージェント（task-starter、task-executer、task-reviewer、task-qa、task-finisher）を呼び出した後：
1. エージェントが生成した最終メッセージ（完了報告）を取得
2. その完了報告をそのまま出力して、ユーザーに見せる
3. 完了報告は「## 📋 タスク選定完了」のような絵文字付き見出しで始まる構造化マークダウン
4. **単に「Done」だけでなく、サブエージェントの詳細な報告内容を表示すること**

## タスク実行の指示

ユーザーから「$ARGUMENTS」を使用したタスクグループ実行を依頼されました。

### 入力の解析
$ARGUMENTSには以下が含まれる可能性があります：
- **Issue番号**（必須、例: `#123`、`123`）
- **タスクグループ番号**（オプション、例: `1.1`、`2.3`）

Issue番号が指定されていない場合は、ユーザーに入力を要求します。

## 処理フロー

このコマンドは選定されたタスク（1個または複数）を実行し、完了後にコマンドを終了します。
ただし、完了後にユーザーから追加の指示があった場合は、task-executerのみを再実行して軽微な修正に対応します：

### タスク実行フロー（汎用）

#### ステップ1: タスク選定
1. task-starterを呼び出し（自然言語指示に応じて1個または複数選定）
2. 完了報告を表示
3. 選定されたタスクがない場合は、その旨を表示して終了

#### ステップ2: タスク実行（品質保証ループ付きパイプライン）

**⚠️ 超重要**:
- このステップは品質保証が合格するまで自動的にループします
- **各フェーズ完了後、完了報告を表示した直後、ユーザーの応答を待たずに即座に次のフェーズを開始します**
- **絶対に**完了報告の表示だけで処理を止めてはいけません
- executer → reviewer → qa → finisher の流れを**自動的に**進めます
- ユーザーからの確認や追加指示を待つことは**禁止**されています

選定されたタスクを以下の順序で実行：

**品質保証ループ開始** ⟲

1. **task-executer**: 実装フェーズ
   - 選定タスクが1個の場合: そのタスク用にtask-executerサブエージェントを1回呼び出し
   - 選定タスクが複数の場合: **各タスクごとに**task-executerサブエージェントを順次呼び出し（1タスク = 1サブエージェント実行）
   - 完了後、完了報告を表示
   - → **完了報告表示の直後、即座にreviewerフェーズへ進む（待機禁止）**

2. **task-reviewer**: レビューフェーズ
   - 選定タスクが1個の場合: そのタスクをレビュー
   - 選定タスクが複数の場合: 全タスクを一括レビュー
   - task-executerサブエージェント完了後に開始
   - 完了後、完了報告を表示
   - **問題発見時**: → **完了報告表示の直後、即座にexecuterフェーズに戻る（ステップ1へ、待機禁止）** ⟲
   - **問題なし**: → **完了報告表示の直後、即座にqaフェーズへ進む（待機禁止）**

3. **task-qa**: 品質保証フェーズ
   - 選定タスクが1個の場合: そのタスクをテスト
   - 選定タスクが複数の場合: 全タスクを一括テスト
   - task-reviewerサブエージェント完了後に開始
   - **検証レベルが「Integration」「E2E」の AC のみをテスト**
   - 完了後、完了報告を表示
   - **テスト失敗時**:
     - 失敗原因を分類（A/B/C/D）
     - 完了報告に分類結果と推奨アクションを記載
     - → **分類に応じた戻し先に自動的に進む（待機禁止）** ⟲
       - A: 実装ミス → executer
       - B: 要件齟齬 → requirements.md 修正 → executer
       - C: 設計不備 → design.md 修正 → executer
       - D: 環境問題 → qa 再実行
   - **全テスト合格**: → **完了報告表示の直後、即座にfinisherフェーズへ進む（ループ終了、待機禁止）**

**品質保証ループ終了** ✓

4. **task-finisher**: 完了処理フェーズ
   - 選定タスクが1個の場合: そのタスクを完了に変更
   - 選定タスクが複数の場合: 全タスクを完了に変更
   - **必ず**GitHub Issueの完了したタスクグループにチェックマークを入れる
   - task-qaサブエージェント完了後に開始（全テスト合格が前提）
   - 完了後、完了報告を表示
   - → **コマンド終了**

#### ステップ3: コマンド終了

finisher完了後、タスク完了を報告し、コマンドを終了します。

### タスク完了後の追加修正対応

コマンド終了後、ユーザーから追加の修正や改善の指示があった場合、以下のフローで対応します：

**フロー**:
```
コマンド終了
    ↓
ユーザーから追加の修正指示
    ↓
task-modification-analyzer を呼び出し
    ↓
分析結果・提案を表示
（ドキュメント修正必要性、修正規模、再レビュー/再QA必要性を判定）
    ↓
ユーザーの承諾を待つ
    ↓（承諾）
analyzerの推奨に基づいて実行
```

**実行パターン**:

**パターンA: executer単独**（小規模・単純な修正）
- 対象: 1-2ファイルの軽微な修正、文言修正、スタイル調整など
- 判定: 再レビュー/再QA不要
- フロー:
  1. ドキュメント更新（analyzer が必要と判定した場合のみ）
  2. `task-executer` のみ実行
- 特徴: 軽微な修正を素早く対応

**パターンB: フルパイプライン**（中規模以上の修正）
- 対象: ロジック変更、新機能追加、複数コンポーネントに影響
- 判定: 再レビュー/再QA必要
- フロー:
  1. ドキュメント更新（analyzer が必要と判定した場合のみ）
  2. `task-executer` → `task-reviewer` → `task-qa` → `task-finisher`
- 特徴: 品質保証のため完全なパイプラインを実行

### 重要事項

#### サブエージェント完了報告の表示
- **各サブエージェント完了後、必ずそのエージェントが生成した完了報告（markdown形式）をそのまま出力してください**
- サブエージェントの報告は「## 🔨 実装フェーズ完了」のような絵文字付き見出しで始まる構造化されたマークダウンです

## 実行例（あくまで一例）

```bash
# 1タスクグループ実行（自動選定）
task-exec #123

# 1タスクグループ実行（明示的指定）
task-exec #123 1.1
task-exec #123 2.3

# Issue番号のみ（#なし）
task-exec 123
task-exec 123 1.1
```

## 内部処理

このコマンドは`Task`ツールを使用して、専用サブエージェントを組み合わせて実行します：

### タスク実行フローの詳細

#### 1. タスク選定フェーズ（task-starter）
- GitHub Issueから着手可能なタスクグループを選定（1個または複数）
- 自然言語指示に応じて選定数を決定
- 選定したタスクグループを着手中状態（`[🔄]`）に変更
- **完了時**: task-starterが生成した「## 📋 タスク選定完了」で始まる完了報告を取得し、そのまま出力してユーザーに表示する
- **完了報告表示の直後、即座にexecuterフェーズへ進む（待機禁止）**

#### 2. 実装フェーズ（task-executer）
- 選定タスクが1個の場合: そのタスク用にtask-executerサブエージェントを1回呼び出し
- 選定タスクが複数の場合: **各タスクごとに**task-executerサブエージェントを順次呼び出し（1タスク = 1サブエージェント実行）
- 要件定義・設計書に基づいた高品質な実装を実行
- **完了時**: task-executerが生成した「## 🔨 実装フェーズ完了」で始まる完了報告を取得し、そのまま出力してユーザーに表示する
- **重要**: このフェーズはreviewer/qaで問題が見つかった場合、自動的に再実行されます
- **完了時の処理**:
  1. 完了報告を表示
  2. 完了報告を表示した**直後**、**ユーザーの応答を待たずに即座に**task-reviewerサブエージェントを呼び出してreviewerフェーズを開始
  3. **絶対に**ユーザーからの確認や追加指示を待ってはいけない
  4. 完了報告の表示だけで処理を止めることは許されない

#### 3. レビューフェーズ（task-reviewer）
- 選定タスクが1個の場合: そのタスクをレビュー
- 選定タスクが複数の場合: 全タスクを一括レビュー
- task-executerサブエージェント完了後に開始
- 要件定義・設計との整合性確認
- 仮実装の検出と後続タスクの確認
- **問題発見時**: task-reviewerが問題を報告
  1. 完了報告に問題点を記載して表示
  2. **自動的にexecuterフェーズに戻る**（task-executerサブエージェントを再呼び出し）
  3. 修正後、再度reviewerフェーズを実行
  4. 問題がなくなるまで繰り返す
- **完了時（問題なし）**:
  1. task-reviewerが生成した完了報告を表示
  2. 完了報告を表示した**直後**、**ユーザーの応答を待たずに即座に**task-qaサブエージェントを呼び出してqaフェーズを開始
  3. **絶対に**ユーザーからの確認や追加指示を待ってはいけない
  4. 完了報告の表示だけで処理を止めることは許されない

#### 4. 品質保証フェーズ（task-qa）
- 選定タスクが1個の場合: そのタスクをテスト
- 選定タスクが複数の場合: 全タスクを一括テスト
- task-reviewerサブエージェント完了後に開始
- 受け入れ条件に基づく動作確認
- 画面: Playwright MCP、API: curl、スクリプト: 実行確認
- **テスト失敗時**: task-qaがテスト失敗を報告
  1. 完了報告に失敗内容を記載して表示
  2. **自動的にexecuterフェーズに戻る**（task-executerサブエージェントを再呼び出し）
  3. 修正後、再度reviewerフェーズ → qaフェーズを実行
  4. すべてのテストが合格するまで繰り返す
- **完了時（全テスト合格）**:
  1. task-qaが生成した完了報告を表示
  2. 完了報告を表示した**直後**、**ユーザーの応答を待たずに即座に**task-finisherサブエージェントを呼び出してfinisherフェーズを開始
  3. **絶対に**ユーザーからの確認や追加指示を待ってはいけない
  4. 完了報告の表示だけで処理を止めることは許されない

#### 5. 完了処理フェーズ（task-finisher）
- 選定タスクが1個の場合: そのタスクを完了状態に変更
- 選定タスクが複数の場合: 全タスクを完了状態に変更
- task-qaサブエージェント完了後に開始（全テスト合格が前提）
- task-finisherサブエージェントを呼び出し
- GitHub Issue内のタスクグループのステータスを完了状態（`[x]`）に変更
- **完了時**: task-finisherが生成した完了報告を表示し、コマンドを終了
- → **コマンド終了** または **追加修正対応フェーズへ**

#### 6. 追加修正対応フェーズ（task-modification-analyzer）（オプション）
- task-finisher完了後、ユーザーから追加の修正指示があった場合に開始
- task-modification-analyzerサブエージェントを呼び出し
- **分析内容**:
  - ユーザー指示の解析（修正カテゴリ、対象の特定）
  - 既存ドキュメント（requirements.md、design.md、GitHub Issue）の確認
  - ドキュメント修正の必要性判定
  - 修正規模・複雑度の判定（小規模/中規模/大規模）
  - 再レビュー/再QA必要性の判定
  - 修正方針の提案
- **完了時**:
  1. task-modification-analyzerが生成した分析レポートを表示
  2. **ユーザーの承諾を待つ**（自動進行しない）
  3. 承諾後、推奨パイプラインに従って実装を開始：
     - パターンA: ドキュメント更新（必要な場合）→ task-executer のみ
     - パターンB: ドキュメント更新（必要な場合）→ executer → reviewer → qa → finisher

---

## 受け入れ条件の参照方法（重要）

このセクションは、task-executer、task-reviewer、task-qaサブエージェントが受け入れ条件を参照する際の標準手順を定義します。

### requirements.mdの標準構造

**必須セクション**:
- **受け入れ基準（Acceptance Criteria）**: このセクションには各ACが以下の形式で記載されます

**AC（Acceptance Criteria）の形式**:
```markdown
##### 機能要件
- [ ] Given: 前提条件
      When: 実行する操作
      Then: 期待される結果
```

### task-executerの受け入れ条件参照方法

1. タスクグループの関連ドキュメント（`requirements.md`）を読み込む
2. 各ユーザーストーリー配下の「受け入れ基準」セクションを特定
3. **検証レベルが「Unit」の AC のみ**を実装対象とする
4. 各 AC（Given/When/Then）に対して実装と単体テストを作成
5. `design.md` の技術仕様に準拠した実装を行う

**検証責務**:
- **Unit テスト**: 必須実装、実装と同時に作成
- **Integration/E2E テスト**: 実装不要（task-qa が担当）

**完了条件**:
- 実装したコードの単体テストが全て合格
- 検証レベルが「Unit」の AC を全て満たす
- Integration/E2E レベルの AC は未検証でも実装フェーズ完了とする

### task-reviewerの受け入れ条件参照方法

1. `requirements.md` の各ユーザーストーリー配下の「受け入れ基準」セクションを参照
2. 実装が各ACを満たしているかを確認
3. ACとの整合性をレビュー観点の最優先項目とする

### task-qaの受け入れ条件参照方法

**⚠️ 最重要**: QAエージェントは以下の手順で受け入れ条件を参照します

1. **受け入れ基準の抽出**
   - タスクグループの `requirements.md` を読み込む
   - 各ユーザーストーリー配下の「受け入れ基準」セクションを特定
   - **検証レベルが「Integration」「E2E」の AC のみ**を抽出
   - 検証レベルが「Unit」の AC はスキップ（task-executer が既に検証済み）

2. **テストシナリオの作成**
   - 各 AC に対して、Given/When/Then に基づくテストシナリオを作成
   - Integration: API + DB + ミドルウェアの連携テスト
   - E2E: Playwright MCP を使用したユーザーシナリオテスト
   - QA 仕様書（`qa-tests/phaseN/X-Y.md`）に記録

3. **SUCCESS 判定基準**
   - **検証レベルが「Integration」「E2E」の全ての AC が満たされた場合のみ**、SUCCESS 判定
   - 1つでも AC を満たさない場合、FAILURE 判定して適切な戻し先を決定

4. **FAILURE 時の原因分類**（後述の失敗リカバリーフロー参照）

5. **参照ドキュメント**
   - QA テスト項目作成方針: `docs/steering/acceptance-criteria-and-qa-guide.md`
   - テンプレート: `docs/templates/requirements.md.template`

---

## 失敗時のリカバリーフロー

### 失敗原因の分類

task-qa は以下の基準で失敗原因を分類し、適切な戻し先を決定します：

#### A: 実装ミス（コードロジックの問題）
- **症状**: 期待値と実際の挙動が異なる、エラーが発生
- **戻し先**: task-executer（実装フェーズ）
- **対応**: コード修正 → 再度 reviewer → qa
- **例**: API が 404 を返す、バリデーションが動作しない

#### B: 要件理解の齟齬（要件定義の問題）
- **症状**: 実装は正しいが、要件と一致しない
- **戻し先**: requirements.md 修正 → 再度 task-executer
- **対応**: 要件明確化 + 再実装 → reviewer → qa
- **例**: 想定していなかったエッジケース、曖昧な要件の誤解

#### C: 設計不備（アーキテクチャの問題）
- **症状**: 実装方法が技術的に不適切
- **戻し先**: design.md 修正 → 再度 task-executer
- **対応**: 設計見直し + 再実装 → reviewer → qa
- **例**: パフォーマンス問題、セキュリティ脆弱性

#### D: テスト環境の問題（一時的なエラー）
- **症状**: 実装は正しいが、環境要因で失敗
- **戻し先**: QA 再実行（修正不要）
- **対応**: 環境調整のみ
- **例**: ネットワークタイムアウト、データベース接続エラー

### task-qa の判定ロジック

1. テスト結果を詳細に確認
2. 失敗原因を以下の 4 分類に分類:
   - A: 実装ミス
   - B: 要件理解の齟齬
   - C: 設計不備
   - D: テスト環境の問題
3. 分類に基づいて戻し先を決定
4. 完了報告に分類結果と推奨アクションを明記
5. 分類に応じた戻し先に自動的に進む

---

## QA仕様書の作成・更新フロー

### 初回実行時（qa-tests/phaseN/X-Y.md が存在しない場合）

1. **ファイルの新規作成**
   - タスクグループ番号に基づいて `qa-tests/phaseN/X-Y.md` を新規作成
   - 例: タスクグループ1.1 → `qa-tests/phase1/1-1.md`

2. **受け入れ基準の抽出**
   - `requirements.md` の各ユーザーストーリー配下の「受け入れ基準」セクションから各ACを抽出

3. **テストシナリオの作成**
   - 各ACに対してテストシナリオを作成
   - テンプレート: `docs/steering/acceptance-criteria-and-qa-guide.md` 参照

4. **QA仕様書の構造**:
```markdown
## 機能名: [タスク名]
- 背景/価値: [requirements.mdから抽出]
- 関連 AC: AC1.1, AC1.2, AC2.1
- テスト範囲: Integration / E2E

- シナリオ:
  1. [AC1.1に対応するシナリオ]
     - 前提: [Given]
     - 操作: [When]
     - 期待結果: [Then]
     - ログ/メトリクス確認方法: [確認手段]

### 実施結果（最終更新: YYYY-MM-DD）
**ステータス: [✅ SUCCESS / ❌ FAILURE / ⚠️ PARTIAL]**
```

### 2回目以降の実行時（qa-tests/phaseN/X-Y.md が既に存在する場合）

1. **既存ファイルの読み込み**
   - `qa-tests/phaseN/X-Y.md` を読み込む

2. **更新対象の特定**
   - 「実施結果」セクションのみを更新対象とする
   - シナリオ部分は**保持**（変更しない）

3. **結果の記録**
   - 最新のテスト実施結果を「実施結果」セクションに追記
   - ステータスを更新（SUCCESS / FAILURE / PARTIAL）

---

## 注意事項

- GitHub Issueのタスク一覧は特定のフォーマットに従っている必要があります
- 依存関係のあるタスクグループは自動的に順序を考慮して実行されます
- 実行中のタスクグループは他のプロセスと競合しないよう管理されます
- **単一タスクグループ実行**: このコマンドは1タスクグループのみを実行し、完了後にコマンドを終了します
- **複数タスクグループの実行**: 複数のタスクグループを実行したい場合は、このコマンドを繰り返し実行してください
- **追加指示への対応**: コマンド完了後にユーザーから追加の修正や改善の指示があった場合、task-modification-analyzerサブエージェントで修正規模と品質保証の必要性を判定し、適切なパイプライン（executer単独 または フルパイプライン）を推奨します
