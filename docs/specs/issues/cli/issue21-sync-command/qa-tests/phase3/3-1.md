# Phase 3: 最適化とオプション機能 QAテスト結果

## テスト対象ユーザーストーリー
- **Story 6**: 強制上書きオプション（AC6.1-6.3）- P2
- **Story 8**: JSON出力オプション（AC8.1-8.3）- P2
- **実装フェーズ**: Phase 3（1週間）
- **テスター**: TBD
- **最終更新**: TBD

## テストサマリー
| ステータス | 件数 |
|----------|-----|
| ✅ PASS | 0 |
| ❌ FAIL | 0 |
| ⚠️ PARTIAL | 0 |
| 🔄 未実施 | 15 |

---

## 必須自動テスト結果

### 実行コマンド
```bash
# 1. ユニットテスト
pnpm test

# 2. 型チェック（TypeScript）
pnpm typecheck

# 3. Lintチェック
pnpm lint

# 4. ビルドチェック
pnpm build
```

### 結果
| テスト項目 | ステータス | 備考 |
|----------|----------|------|
| ユニットテスト | - | 未実施 |
| 型チェック | - | 未実施 |
| Lintチェック | - | 未実施 |
| ビルドチェック | - | 未実施 |

**重要**: 上記のいずれか1つでも失敗した場合、全体ステータスは**❌ FAIL**となります。

---

## Story 6: 強制上書きオプション

### 受け入れ条件
- **AC6.1**: Given: `--force`オプション指定
             When: syncコマンドを実行
             Then: すべてのファイルがテンプレート版で上書きされ、3方向マージはスキップされる
- **AC6.2**: Given: `--force`オプション指定
             When: syncコマンドを実行
             Then: 実行前に確認プロンプト"すべてのローカル変更が失われます。続けますか？"が表示される
- **AC6.3**: Given: `--force --yes`オプション指定
             When: syncコマンドを実行
             Then: 確認プロンプトなしで強制上書きが実行される

### テストシナリオ

#### AC6.1: 強制上書きの実行

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md をローカル編集 | - | - | - | ローカル変更追加 |
| 3 | cat .claude/commands/einja/spec-create.md 実行 | 編集前の内容確認 | ローカル変更が含まれる | - | 実行前の状態確認 |
| 4 | npx @einja/cli sync --force --yes 実行 | コマンド成功 | 終了コード0 | - | --yesで確認スキップ |
| 5 | - | 強制上書きメッセージ | "強制上書きを実行します"等のメッセージ | - | - |
| 6 | cat .claude/commands/einja/spec-create.md 実行 | ローカル変更削除確認 | ローカル変更が失われ、テンプレート版になっている | - | - |
| 7 | ls -la .claude.backup-* 実行 | バックアップ作成確認 | バックアップディレクトリが作成されている | - | - |

#### AC6.2: 確認プロンプトの表示

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクト、ローカル変更あり | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --force 実行 | 確認プロンプト表示 | "すべてのローカル変更が失われます。続けますか？" 表示 | - | - |
| 3 | - | 選択肢表示 | "(Y/n)" 等の選択肢が表示 | - | - |
| 4 | "n" で応答 | 処理中断 | "中断しました"メッセージ、終了コード0 | - | - |
| 5 | cat .claude/commands/einja/spec-create.md 実行 | ファイル変更なし | ローカル変更が保持されている | - | - |
| 6 | npx @einja/cli sync --force 実行（再実行） | 確認プロンプト表示 | 同じプロンプトが表示される | - | - |
| 7 | "Y" で応答 | 強制上書き実行 | "✅ 同期完了!"メッセージ | - | - |
| 8 | cat .claude/commands/einja/spec-create.md 実行 | ローカル変更削除確認 | テンプレート版になっている | - | - |

#### AC6.3: 確認プロンプトのスキップ

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクト、ローカル変更あり | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --force --yes 実行 | プロンプトなし | 確認プロンプトが表示されない | - | - |
| 3 | - | 即座に実行 | "強制上書きを実行します"メッセージ、即座に処理開始 | - | - |
| 4 | - | コマンド成功 | 終了コード0、"✅ 同期完了!" 表示 | - | - |
| 5 | cat .claude/commands/einja/spec-create.md 実行 | ローカル変更削除確認 | テンプレート版になっている | - | - |

**ケース2: バックアップからの手動復元**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | AC6.1で強制上書き実行済みの状態 | - | - | - | テスト環境準備 |
| 2 | ls -la .claude.backup-* 実行 | バックアップ確認 | バックアップディレクトリが存在 | - | - |
| 3 | cat .claude.backup-*/commands/einja/spec-create.md 実行 | バックアップ内容確認 | ローカル変更が保存されている | - | - |
| 4 | cp .claude.backup-*/commands/einja/spec-create.md .claude/commands/einja/ 実行 | 手動復元 | ファイルをコピー | - | - |
| 5 | cat .claude/commands/einja/spec-create.md 実行 | 復元確認 | ローカル変更が復元されている | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- 強制上書き前: `evidence/6-1-before-force.md`
- 強制上書き後: `evidence/6-1-after-force.md`
- バックアップ: `evidence/6-1-backup/`
- 確認プロンプト: `evidence/6-2-prompt.log`

---

## Story 8: JSON出力オプション

### 受け入れ条件
- **AC8.1**: Given: `--json`オプション指定
             When: syncコマンドを実行
             Then: 標準出力にJSON形式で結果が出力される（`{"status": "success", "files": {...}}`）
- **AC8.2**: Given: `--json`オプション指定かつコンフリクト発生
             When: syncコマンドを実行
             Then: JSON内に`"conflicts": [...]`配列でコンフリクト情報が含まれる
- **AC8.3**: Given: `--json`オプション指定
             When: syncコマンドを実行
             Then: ログメッセージ（spinner等）は標準エラー出力に出力され、JSONのみが標準出力に出力される

### テストシナリオ

#### AC8.1: 基本的なJSON出力

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/task-exec.md を編集 | - | - | - | テストデータ準備 |
| 3 | npx @einja/cli sync --json > sync-result.json 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | cat sync-result.json \| jq '.' 実行 | JSON妥当性 | 有効なJSON形式でパースエラーなし | - | - |
| 5 | cat sync-result.json \| jq '.status' 実行 | ステータス確認 | "success" | - | - |
| 6 | cat sync-result.json \| jq '.summary' 実行 | サマリー確認 | total, changed, succeeded等のキーが存在 | - | - |
| 7 | cat sync-result.json \| jq '.files' 実行 | ファイル一覧確認 | 配列形式でファイル情報が含まれる | - | - |
| 8 | cat sync-result.json \| jq '.files\[\] .path' 実行 | ファイルパス確認 | task-exec.mdが含まれる | - | - |
| 9 | cat sync-result.json \| jq '.files\[\] .status' 実行 | ステータス確認 | "success"等の値が存在 | - | - |
| 10 | cat sync-result.json \| jq '.metadata' 実行 | メタデータ確認 | version, syncedAt等のキーが存在 | - | - |

#### AC8.2: コンフリクト情報のJSON出力

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md の行10を編集 | - | - | - | ローカル変更 |
| 3 | テンプレート側も同じ行10を異なる内容で編集（シミュレーション） | - | - | - | コンフリクト条件作成 |
| 4 | npx @einja/cli sync --json > sync-conflict.json 実行 | コンフリクト検出 | 終了コード1 | - | - |
| 5 | cat sync-conflict.json \| jq '.' 実行 | JSON妥当性 | 有効なJSON形式 | - | - |
| 6 | cat sync-conflict.json \| jq '.status' 実行 | ステータス確認 | "partial_success"または"conflict" | - | - |
| 7 | cat sync-conflict.json \| jq '.conflicts' 実行 | コンフリクト配列確認 | 配列形式でコンフリクト情報が含まれる | - | - |
| 8 | cat sync-conflict.json \| jq '.conflicts\[\] .path' 実行 | ファイルパス確認 | spec-create.mdが含まれる | - | - |
| 9 | cat sync-conflict.json \| jq '.conflicts\[\] .line' 実行 | 行番号確認 | 10が含まれる | - | - |
| 10 | cat sync-conflict.json \| jq '.conflicts\[\] .localContent' 実行 | ローカル内容確認 | ローカル変更内容が含まれる | - | - |
| 11 | cat sync-conflict.json \| jq '.conflicts\[\] .templateContent' 実行 | テンプレート内容確認 | テンプレート変更内容が含まれる | - | - |

#### AC8.3: ログとJSONの分離出力

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --json 2> stderr.log > stdout.json 実行 | コマンド成功 | 終了コード0 | - | - |
| 3 | cat stdout.json \| jq '.' 実行 | JSON出力確認 | 有効なJSON形式、純粋なJSONのみ | - | 標準出力はJSONのみ |
| 4 | cat stderr.log 実行 | ログ出力確認 | スピナー、進捗メッセージ等が含まれる | - | 標準エラー出力にログ |
| 5 | grep "🔄" stderr.log 実行 | スピナー確認 | スピナー絵文字が含まれる | - | - |
| 6 | grep "✅" stderr.log 実行 | 完了メッセージ確認 | 完了メッセージが含まれる | - | - |
| 7 | grep "🔄\|✅" stdout.json 実行 | JSON内にログなし | ログメッセージが含まれない（終了コード1） | - | - |

**ケース2: CI/CDパイプラインでの使用シミュレーション**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --json \| jq '.status' 実行 | パイプライン処理 | "success"等のステータスが出力される | - | CI/CD想定 |
| 3 | npx @einja/cli sync --json \| jq '.summary.succeeded' 実行 | 成功ファイル数取得 | 数値が出力される | - | - |
| 4 | if \[ \$(npx @einja/cli sync --json \| jq -r '.status') = "success" \]; then echo "OK"; fi 実行 | 条件分岐 | "OK"が表示される | - | シェルスクリプト統合 |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- JSON出力（成功）: `evidence/8-1-sync-success.json`
- JSON出力（コンフリクト）: `evidence/8-2-sync-conflict.json`
- 標準エラー出力ログ: `evidence/8-3-stderr.log`

---

## 統合テスト結果サマリー

### Phase 3全体結果
- **全体ステータス**: 🔄 未実施
- **完了ストーリー**: 0/2（Story 6, 8）
- **テスト合格率**: 0% (0/15)

### 修正が必要な項目
（実施後に記載）

### 次フェーズへの引き継ぎ事項
（実施後に記載）

### 改善提案
（実施後に記載）

---

## 報告と対応

### 失敗原因分類
<!-- 該当する分類にチェック -->
- [ ] **A: 実装ミス** → task-executerへ差し戻し
- [ ] **B: 要件齟齬** → requirements.md修正 → task-executerへ差し戻し
- [ ] **C: 設計不備** → design.md修正 → task-executerへ差し戻し
- [ ] **D: 環境問題** → qa再実行

### task-executerへの差し戻し（該当する場合）
（実施後に記載）

### 修正優先度
（実施後に記載）

### 回避策（該当する場合）
（実施後に記載）
