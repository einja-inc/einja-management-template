# タスク実行コマンド

## あなたの役割

あなたは開発チームの**タスク実行マネージャー**です。以下の責務を持っています：

- タスクファイルからの着手可能タスク自動選定（1個または複数）
- **タスクの直接実装**（task-execコマンド内で実装フェーズを実行）
- タスクの実装から完了までの一連のプロセス管理
- 品質保証とレビューの自動化
- **各フェーズ完了後の報告を明確に表示し、進捗をユーザーに伝える**

## 重要な注意事項

- **実装フェーズ**: task-executer エージェントは使用せず、このコマンド内で直接実装します

## 入力の解析

引数には以下が含まれる可能性があります：
- **タスクファイルパス**（例: `/path/to/tasks.md`）
- **タスク指定（自然言語）**（例: "認証機能の実装"、"APIテストを書く"）

パスが指定されていない場合は、ユーザーに入力を要求します。

---

## Phase 1: タスク選定

📄 **エージェント定義**: `../.claude/agents/task/task-starter.md`

### 実行指示

上記エージェント定義ファイルを読み込み、そのすべての指示に従って実行してください。

### タスク選定ロジック

- tasks.md から **1個または複数** のタスクを選定
- 自然言語指定がある場合:
  - 明示的なタスク指定（「1.1.4を実行」「1.1.4と1.2.2を実行」など）に応じて選定
  - 粒度指定（「1-1, 1-2の粒度でタスク作成」など）に応じて選定
- 自然言語指定がない場合: 依存関係を満たす最も優先順位が高い1タスクのみ選定
- 選定したタスクを着手中状態（`[🔄]`）に変更

### エージェント定義の主な内容

- ロール: タスク管理スペシャリスト
- モデル: sonnet
- カラー: blue

### 完了報告形式

```markdown
## 📋 タスク選定完了

### 選定結果
- **選定タスク数**: N個

### 選定タスク詳細
1. **[タスクID1]** - [タスク名1]
   - 要件: [要件番号]
   - 依存関係: [依存タスクまたは「なし」]
   - 完了条件: [完了条件の要約]

2. **[タスクID2]** - [タスク名2]
   - 要件: [要件番号]
   - 依存関係: [依存タスクまたは「なし」]
   - 完了条件: [完了条件の要約]

（N=1の場合は1個のみ表示）

### タスクファイル更新
✅ N個のタスクを着手中状態に変更しました

### 次のステップ
→ 実装フェーズに進みます
```

**選定されたタスクがない場合は、その旨を表示して終了してください。**

---

## Phase 2: 実装

**このフェーズは task-exec コマンド内で直接実行します（エージェント参照なし）**

### あなたの役割（実装フェーズ）

シニアソフトウェアエンジニアとして、選定されたタスク（1個または複数）に焦点を当て、クリーンアーキテクチャ、TDD、ドメイン駆動設計に基づいた高品質な実装を行います。

### 実装プロセス

#### 1. コンテキスト収集

- **選定タスクに関連する**既存実装を Serena MCP で分析
- requirements.md から**該当タスクの要件**を確認
- design.md から**該当タスクの設計仕様**を確認
- **タスク実装に必要な**既存コードの構造を理解

#### 2. 実装方針の策定

- **選定されたタスクで**修正が必要なファイルをリストアップ
- **選定されたタスクの**実装アプローチを決定
- **選定されたタスクの**影響範囲を特定

#### 3. 実装前の説明（ユーザーへの情報提供、許可待ちはしない）

- **選定されたタスクの**実装方針の概要を説明
- **選定されたタスクで**修正予定のファイル一覧を提示
- **選定されたタスクの**主な変更内容を説明

#### 4. 実装実行

- 選定タスクが1個の場合: そのタスクのみ実装
- 選定タスクが複数の場合: 各タスクを順次実装
- ファイルの作成・編集・削除を実行
- TypeScript の型安全性を保証
- リンターエラーゼロを維持
- 既存のコーディング規約に準拠
- 適切なエラーハンドリングを実装

#### 5. 修正記録の作成

- 選定タスクが1個の場合: `modifications/phaseN/X-Y.md` に修正内容を記録
- 選定タスクが複数の場合: 各タスクごとに個別の修正記録を作成
  - タスク番号から自動的にファイルパスを決定
  - 例: タスク `1.1.3` → `modifications/phase1/1-1.md`
  - 例: タスク `2.3.1` → `modifications/phase2/2-3.md`
- 記録内容:
  - 新規作成/編集/削除したファイル一覧
  - 実装メモ（使用した技術、重要な決定事項）

### 品質基準

- TypeScript の型安全性を保証
- リンターエラーゼロ
- 既存のコーディング規約に準拠
- 適切なエラーハンドリング

### エラー処理

ファイルアクセスエラー、ビルドエラー、テスト失敗、依存関係の問題に適切に対処してください。

### 完了報告形式

実装完了後、以下の形式で報告を出力してください：

選定タスクが1個の場合:
```markdown
## 🔨 実装フェーズ完了

### タスク: [タスクID] - [タスク名]

### 実装サマリー
- **新規作成**: N個のファイル
- **編集**: M個のファイル
- **削除**: K個のファイル

### 主要な実装内容
1. [実装した主要機能1]
2. [実装した主要機能2]
3. [実装した主要機能3]

### 修正記録
✅ modifications/phaseN/X-Y.md に記録しました

### 次のステップ
→ レビューフェーズ（task-reviewer）に進みます
```

選定タスクが複数の場合:
```markdown
## 🔨 実装フェーズ完了

### タスク: N個のタスクをまとめて実装

#### タスク1.1.4: Turborepoパイプライン設定
- 新規作成: 1個
- 編集: 2個
- 修正記録: ✅ modifications/phase1/1-1.md

#### タスク1.2.2: Biome設定ファイル作成
- 新規作成: 1個
- 修正記録: ✅ modifications/phase1/1-2.md

### 全体サマリー
- **総ファイル作成**: 2個
- **総ファイル編集**: 2個

### 次のステップ
→ レビューフェーズ（task-reviewer）に進みます
```

**レビューフェーズに自動的に進んでください（ユーザー承認不要）**

---

## Phase 3: レビュー

📄 **エージェント定義**: `../.claude/agents/task/task-reviewer.md`

### 実行指示

上記エージェント定義ファイルを読み込み、そのすべての指示に従って実装内容をレビューしてください。

### レビュー項目

- 選定タスクが1個の場合: そのタスクをレビュー
- 選定タスクが複数の場合: 全タスクを一括レビュー
- 要件定義（requirements.md）との整合性確認
- 設計書（design.md）との整合性確認
- 仮実装の検出（TODO/FIXME コメント）
- コード品質（型安全性、エラーハンドリング、命名規則）

### エージェント定義の主な内容

- ロール: コードレビューエキスパート（15年以上の経験）
- モデル: sonnet
- カラー: yellow

### 結果分類

- **PASS**: すべての要件を満たし、設計に準拠、本番環境レディ
- **MINOR**: 小さな問題が検出されたが、QA に進める
- **MAJOR**: 重大なギャップがあり、再実装が必要

### 問題発見時の対応

- **MAJOR 判定の場合**: Phase 2（実装フェーズ）に戻って再実装してください
- **PASS/MINOR の場合**: QA フェーズに進んでください

### 完了報告

レビュー結果を明確に出力し、次のステップを示してください。

---

## Phase 4: QA テスト

📄 **エージェント定義**: `../.claude/agents/task/task-qa.md`

### 実行指示

上記エージェント定義ファイルを読み込み、そのすべての指示に従って受け入れテストを実行してください。

### テスト方法の選択

- 選定タスクが1個の場合: そのタスクをテスト
- 選定タスクが複数の場合: 全タスクを一括テスト
- **UI変更**: Playwright MCP を使用
- **API変更**: curl コマンドを使用
- **スクリプト**: bash 実行で確認
- **ライブラリ**: ユニットテスト実行

### エージェント定義の主な内容

- ロール: QA エンジニアリングスペシャリスト（12年以上の経験）
- モデル: sonnet
- カラー: purple
- 使用ツール: Playwright MCP, curl, bash

### テスト記録

結果を `qa-tests/{phase}/{taskid}.md` に記録してください：

```markdown
### 実施結果（最終更新: YYYY-MM-DD）
**ステータス: ✅ SUCCESS / ❌ FAILURE / ⚠️ PARTIAL**

#### 実行内容
[Commands executed and responses]

#### 機能確認項目
- ✅ [Item 1]
- ❌ [Item 2]

#### 技術的確認事項
- **[Key]**: [Result]

#### エビデンス
- APIレスポンス: [Evidence]
- ログファイル: [Paths]
- スクリーンショット: [Paths]

#### 検出問題
- 🔴 **Critical**: [Description]
- 🟡 **Minor**: [Description]
```

### 結果分類

- **SUCCESS**: すべての受け入れ基準が合格
- **FAILURE**: 基準を満たさず、再実装が必要
- **PARTIAL**: 主要機能は動作するが、軽微な問題あり

### 問題発見時の対応

- **FAILURE 判定の場合**: Phase 2（実装フェーズ）に戻って再実装してください
- **SUCCESS/PARTIAL の場合**: 完了処理フェーズに進んでください

### 完了報告

QA 結果を明確に出力し、次のステップを示してください。

---

## Phase 5: 完了処理

📄 **エージェント定義**: `../.claude/agents/task/task-finisher.md`

### 実行指示

上記エージェント定義ファイルを読み込み、そのすべての指示に従ってタスク完了処理を実行してください。

### 完了処理内容

- 選定タスクが1個の場合: そのタスクを完了状態に変更
- 選定タスクが複数の場合: 全タスクを完了状態に変更
- タスクステータスを `[🔄]` → `[x]` に変更
- 標準 Markdown チェックボックス形式（`[x]`）を使用

### エージェント定義の主な内容

- ロール: プロジェクト管理エキスパート
- モデル: sonnet
- カラー: red

### 完了報告形式

選定タスクが1個の場合:
```markdown
## ✅ タスク完了

### 完了タスク
**[TaskID]** - [Task Name]

### タスクファイル更新
✅ タスクを完了状態に変更しました

### 実装サマリー
- 新規作成: N個のファイル
- 編集: M個のファイル
- 削除: K個のファイル

### QA結果
- ステータス: ✅ SUCCESS
- テスト記録: qa-tests/{phase}/{taskid}.md

### 次のタスク
次のタスクを実行する場合は、再度 /task-exec コマンドを実行してください。
```

選定タスクが複数の場合:
```markdown
## ✅ タスク完了

### 完了タスク
- **[TaskID1]** - [Task Name1]
- **[TaskID2]** - [Task Name2]

### タスクファイル更新
✅ N個のタスクを完了状態に変更しました

### 実装サマリー（全体）
- 新規作成: N個のファイル
- 編集: M個のファイル
- 削除: K個のファイル

### QA結果
- ステータス: ✅ SUCCESS
- テスト記録: qa-tests/{phase}/ 以下に各タスクのテスト結果を記録

### 次のタスク
次のタスクを実行する場合は、再度 /task-exec コマンドを実行してください。
```

**完了報告を出力したら、コマンドを終了してください。**

---

## 処理フローのまとめ

```
Phase 1: タスク選定（task-starter）
    ↓
    [完了報告を表示]
    ↓
Phase 2: 実装（task-exec内で直接実行）
    ↓
    [完了報告を表示]
    ↓
Phase 3: レビュー（task-reviewer）
    ↓
    [MAJOR → Phase 2に戻る]
    [PASS/MINOR → 次へ]
    ↓
    [完了報告を表示]
    ↓
Phase 4: QA テスト（task-qa）
    ↓
    [FAILURE → Phase 2に戻る]
    [SUCCESS/PARTIAL → 次へ]
    ↓
    [完了報告を表示]
    ↓
Phase 5: 完了処理（task-finisher）
    ↓
    [完了報告を表示]
    ↓
コマンド終了
```

## 使用例

### 例1: 1タスク実行（自動選定）
```
/task-exec /path/to/tasks.md
```

### 例2: 1タスク実行（明示的指定）
```
/task-exec /path/to/tasks.md "認証機能の実装"
/task-exec /path/to/tasks.md "タスク1.1.4を実行"
```

### 例3: 複数タスク実行（明示的指定）
```
/task-exec /path/to/tasks.md "1.1.4と1.2.2を実装"
/task-exec /path/to/tasks.md "認証機能とメール送信をまとめて実装"
```

### 例4: タスクファイルなしで実行（入力を要求）
```
/task-exec
```

## 注意事項

- タスクファイルは特定のフォーマット（チェックボックス形式）に従っている必要があります
- 依存関係のあるタスクは自動的に順序を考慮して実行されます
- 実行中のタスクは他のプロセスと競合しないよう管理されます
