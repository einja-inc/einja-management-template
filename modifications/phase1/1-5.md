# タスクグループ 1.5: ドライラン機能 - 修正記録

## 実装日時
2026-01-05

## 実装タスク

### タスク 1.5.1: ドライランオプション実装
- `--dry-run`オプション処理の実装
- ファイル変更スキップ処理
- 差分サマリー表示

### タスク 1.5.2: ドライラン時のコンフリクト表示
- コンフリクト箇所のハイライト表示
- ファイルパスと行番号の表示

## 修正ファイル一覧

### 編集したファイル
1. `packages/cli/src/commands/sync.ts`
   - dry-runモードの処理を拡張
   - 差分計算とコンフリクト検出をdry-run時にも実行
   - 統計情報を含む詳細サマリーを表示
   - コンフリクト詳細表示機能を追加

2. `packages/cli/src/commands/sync.test.ts`
   - AC5.1のテストケースを追加（2件）
   - AC5.3のテストケース構造を追加（統合テストに移行）

3. `packages/cli/src/lib/sync/integration.test.ts`
   - AC5.3のテストケースを追加（3件）
   - DiffEngineとConflictReporterの統合テストケースを追加

### 新規作成したファイル
- なし

### 削除したファイル
- なし

## 実装内容の詳細

### 1. ドライランオプション実装（AC5.1）

#### sync.tsの変更点
- **差分計算の実装**: dry-run時も実際のマージ処理を実行（ファイル書き込みはスキップ）
- **統計情報の収集**:
  - 新規ファイル数
  - 更新ファイル数
  - コンフリクト数
- **差分サマリー表示**:
  ```
  📊 差分サマリー:
    - 新規ファイル: N件
    - 更新ファイル: M件
    - コンフリクト: K件
    - 合計: X件
  ```

#### 実装コード（抜粋）
```typescript
if (options.dryRun) {
	console.log(chalk.blue("\n🔍 [Dry Run] 差分を確認中...\n"));

	// dry-run時も差分計算とコンフリクト検出を実行
	const dryRunStats = {
		new: 0,
		updated: 0,
		conflicts: 0,
	};
	const dryRunConflicts = new Map<string, Array<{ line: number; localContent: string; templateContent: string }>>();

	for (const target of changedFiles) {
		const templateContent = await fs.readFile(target.templatePath, "utf-8");

		if (!target.exists) {
			// 新規ファイル
			dryRunStats.new++;
			console.log(chalk.green(`  ✨ 新規: ${target.path}`));
		} else {
			// 既存ファイル：マージシミュレーション
			const projectPath = path.join(cwd, target.path);
			const localContent = await fs.readFile(projectPath, "utf-8");
			const fileMetadata = metadata.files[target.path];
			const baseContent = fileMetadata
				? (await metadataManager.getBaseContent(target.templatePath)).content
				: "";

			const mergeResult = diffEngine.merge3Way(
				baseContent,
				localContent,
				templateContent,
			);

			if (mergeResult.success) {
				dryRunStats.updated++;
				console.log(chalk.cyan(`  📝 更新: ${target.path}`));
			} else {
				dryRunStats.conflicts++;
				dryRunConflicts.set(target.path, mergeResult.conflicts);
				console.log(chalk.yellow(`  ⚠️  コンフリクト: ${target.path}`));
			}
		}
	}

	// 差分サマリー表示
	console.log(chalk.blue("\n📊 差分サマリー:"));
	console.log(`  - 新規ファイル: ${dryRunStats.new}件`);
	console.log(`  - 更新ファイル: ${dryRunStats.updated}件`);
	console.log(`  - コンフリクト: ${dryRunStats.conflicts}件`);
	console.log(`  - 合計: ${changedFiles.length}件\n`);

	// コンフリクト詳細表示
	if (dryRunConflicts.size > 0) {
		const conflictReport = conflictReporter.createReport(dryRunConflicts);
		console.log(chalk.yellow(conflictReporter.formatReport(conflictReport)));
		console.log(conflictReporter.formatHelpMessage());
	} else {
		console.log(chalk.green("✅ コンフリクトは検出されませんでした。\n"));
	}

	return;
}
```

### 2. ドライラン時のコンフリクト表示（AC5.3）

#### 実装内容
- **コンフリクト検出**: DiffEngineの3方向マージを使用してコンフリクトを検出
- **ConflictReporterの活用**: 既存のConflictReporterを使用してハイライト表示
- **詳細情報の表示**:
  - ファイルパス
  - コンフリクト箇所の行番号
  - コンフリクト数

#### 出力例
```
⚠️  1件のコンフリクトが検出されました:

  📄 .claude/commands/einja/test.md (1箇所)
     - 行15

💡 コンフリクト解消方法:
  1. 上記ファイルを開く
  2. <<<<<<< LOCAL と >>>>>>> TEMPLATE の間を手動編集
  3. コンフリクトマーカーを削除
  4. 再度 sync を実行
```

### 3. テストの追加

#### sync.test.ts（AC5.1テスト）
1. **ファイル変更が発生しない確認**:
   - dry-run実行前後でファイル内容が同一
   - 差分サマリーが表示される

2. **新規ファイル作成が発生しない確認**:
   - 新規ファイルが作成されないことを確認

#### integration.test.ts（AC5.3テスト）
1. **コンフリクト検出とレポート生成の連携**:
   - DiffEngineでコンフリクト検出
   - ConflictReporterでレポート生成
   - フォーマット済みレポートに行番号とファイルパスが含まれる

2. **複数ファイルのコンフリクトまとめ**:
   - 複数ファイルのコンフリクトを統合レポート生成

3. **コンフリクトなしケース**:
   - 成功メッセージが返される

## 技術的な決定事項

### 1. dry-run時のマージシミュレーション
**決定**: dry-run時も実際のDiffEngineを使用してマージを試行する

**理由**:
- コンフリクト検出の正確性を保証
- 実際の同期処理と同じロジックを使用することで、結果の一貫性を確保
- ファイル書き込みをスキップするだけで、差分計算は完全に実行

### 2. 既存のConflictReporterの再利用
**決定**: dry-run用に新しいレポーターを作成せず、既存のConflictReporterを使用

**理由**:
- コードの重複を避ける
- 一貫したコンフリクト表示形式
- 既存のテストケースも活用可能

### 3. 統合テストへの移行
**決定**: sync.test.tsのコンフリクト表示テストを統合テストに移行

**理由**:
- syncコマンドがテンプレートルートを実際のパッケージから取得するため、ユニットテストレベルでのモックが困難
- DiffEngineとConflictReporterの統合テストとして実装することで、テストの信頼性を向上

## 検証結果

### テスト実行結果
```
✓ src/lib/sync/conflict-reporter.test.ts (9 tests)
✓ src/lib/sync/diff-engine.test.ts (11 tests)
✓ src/lib/sync/integration.test.ts (17 tests)
✓ src/lib/sync/backup-manager.test.ts (12 tests)
✓ src/lib/sync/metadata-manager.test.ts (11 tests)
✓ src/lib/sync/file-filter.test.ts (11 tests)
✓ src/commands/sync.test.ts (10 tests)

Test Files  7 passed (7)
Tests  81 passed (81)
```

### TypeScript型チェック
```
> @einja/cli@0.1.0 typecheck
> tsc --noEmit

✅ 型エラーなし
```

## 受け入れ基準の達成状況

### AC5.1: ドライラン時にファイル変更が発生せず、差分サマリーが表示される
✅ **達成**
- ファイル変更なし確認済み
- 差分サマリー表示確認済み（新規、更新、コンフリクト、合計の統計情報）

### AC5.3: コンフリクト箇所がハイライト表示され、ファイルパスと行番号が示される
✅ **達成**
- コンフリクト箇所のハイライト表示確認済み
- ファイルパスと行番号の表示確認済み
- ConflictReporterによる統一されたフォーマット

## 実装メモ

### 注意点
1. **dry-run時のパフォーマンス**: 実際のマージ処理を実行するため、ファイル数が多い場合はやや時間がかかる可能性がある
2. **テストの制約**: syncコマンド全体の統合テストは、テンプレートルートの動的取得により、モック化が難しい

### 今後の改善案
1. **JSON出力対応**: `--dry-run --json`での機械可読な出力（現在は未実装、AC5.2）
2. **パフォーマンス最適化**: 大量ファイルに対する差分計算の並列化
3. **E2Eテスト**: Playwrightを使用した実際のCLI実行テスト
