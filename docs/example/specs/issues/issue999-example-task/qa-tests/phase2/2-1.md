# Phase 2: 認証API実装 QAテスト結果

## テスト概要
- **テスト対象**: Phase 2 認証API実装
- **対応タスク**: 2.1.1 ~ 2.1.8
- **実施日**: YYYY-MM-DD
- **テスター**: [名前]
- **最終更新**: YYYY-MM-DD HH:MM

## テストサマリー
| ステータス | 件数 |
|----------|-----|
| ✅ PASS | 0 |
| ❌ FAIL | 0 |
| ⚠️ PARTIAL | 0 |
| 🔄 未実施 | 8 |

## タスク2.1.1: マジックリンク送信API実装

### API統合テスト

| No | エンドポイント | メソッド | リクエストボディ | 期待されるレスポンス | 結果 | 備考 |
|----|-------------|---------|---------------|------------------|------|------|
| 1 | /api/auth/magic-link | POST | {"email":"test@example.com"} | 200, {"success":true,"message":"..."} | - | - |
| 2 | /api/auth/magic-link | POST | {"email":"invalid-email"} | 400, バリデーションエラー | - | - |
| 3 | /api/auth/magic-link | POST | {} | 400, 必須フィールドエラー | - | - |
| 4 | /api/auth/magic-link | POST | 同一メールで1分以内に再送 | 429, レート制限エラー | - | - |
| 5 | /api/auth/magic-link | POST | 同一IPから1分以内に4回目 | 429, レート制限エラー | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.2: トークン検証API実装

### API検証ロジックテスト

| No | テストシナリオ | トークン状態 | 期待されるレスポンス | 結果 | 備考 |
|----|-------------|-----------|------------------|------|------|
| 1 | 有効なトークンで検証 | 有効、未使用 | 200, セッション作成成功 | - | - |
| 2 | 期限切れトークンで検証 | 期限切れ | 401, TOKEN_EXPIRED | - | - |
| 3 | 使用済みトークンで検証 | 使用済み | 401, TOKEN_USED | - | - |
| 4 | 無効なトークンで検証 | 存在しない | 401, TOKEN_INVALID | - | - |
| 5 | トークンなしで検証 | - | 400, バリデーションエラー | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.3: トークン検証画面コンポーネント実装

### コンポーネント単体テスト

| No | テスト項目 | 期待値 | 結果 | 備考 |
|----|---------|--------|------|------|
| 1 | TokenVerifyingコンポーネントがレンダリングされる | コンポーネントがDOMに存在 | - | - |
| 2 | ローディングスピナーが表示される | スピナー要素が存在 | - | - |
| 3 | 検証中メッセージが表示される | 「認証しています...」メッセージ表示 | - | - |
| 4 | マウント時に自動検証が開始される | API呼び出しが実行される | - | - |
| 5 | 検証成功時に自動リダイレクトされる | 3秒以内にダッシュボードへ遷移 | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.4: エラー画面コンポーネント実装

### エラーパターンテスト

| No | エラー種別 | 期待される表示内容 | 結果 | 備考 |
|----|---------|----------------|------|------|
| 1 | TOKEN_EXPIRED | 「リンクの有効期限が切れています」タイトル、「新しいリンクを送信」ボタン | - | - |
| 2 | TOKEN_USED | 「このリンクは既に使用されています」タイトル、「新しいリンクを送信」ボタン | - | - |
| 3 | TOKEN_INVALID | 「無効なリンクです」タイトル、「ログインページに戻る」ボタン | - | - |
| 4 | RATE_LIMIT | 「リクエスト回数の上限に達しました」タイトル、リトライ可能時刻表示 | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.5: 認証フロー統合実装

### 統合テスト

| No | テストシナリオ | 期待される動作 | 結果 | 備考 |
|----|-------------|-------------|------|------|
| 1 | ログイン画面からメール送信まで | API呼び出し成功、確認画面遷移 | - | - |
| 2 | マジックリンククリックから認証まで | トークン検証、ダッシュボード遷移 | - | - |
| 3 | エラー発生時の画面遷移 | 適切なエラー画面表示 | - | - |
| 4 | エラーからのリカバリー | ログイン画面に戻り再試行可能 | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.6: UIインタラクションテスト作成・実行

### トークン検証画面のインタラクションテスト

| No | テストシナリオ | 操作 | 期待される反応 | 結果 | 備考 |
|----|--------------|------|-------------|------|------|
| 1 | 初期表示 | マジックリンクをクリック | ローディングスピナー表示、「認証しています...」メッセージ表示 | - | - |
| 2 | 検証処理実行 | 画面表示直後 | 自動的にトークン検証API呼び出し | - | - |
| 3 | ローディング状態（短時間） | 検証開始後2秒以内 | スピナーとメッセージのみ表示 | - | - |
| 4 | プログレスバー表示 | 検証開始後3秒以上経過 | プログレスバー追加表示 | - | - |
| 5 | 検証成功 | トークンが有効 | メッセージが「ログインしています...」に変更 | - | - |
| 6 | 自動リダイレクト | 検証成功後 | 3秒以内にダッシュボードへ自動リダイレクト | - | - |
| 7 | 戻るボタン防止 | 検証中にブラウザ戻るボタン | 警告表示または無効化 | - | - |

### エラー画面のインタラクションテスト

#### トークン期限切れエラー

| No | テストシナリオ | 操作 | 期待される反応 | 結果 | 備考 |
|----|--------------|------|-------------|------|------|
| 1 | エラー画面表示 | 期限切れトークンで検証 | 「リンクの有効期限が切れています」タイトル表示 | - | - |
| 2 | エラーメッセージ | エラー画面表示 | 詳細メッセージと対処法表示 | - | - |
| 3 | リカバリーアクション | 「新しいリンクを送信」ボタン表示 | ボタンがクリック可能状態 | - | - |
| 4 | ボタンクリック | 「新しいリンクを送信」をクリック | ログイン画面に遷移 | - | - |
| 5 | メールアドレスプリフィル | ログイン画面遷移後 | 前回使用したメールアドレスがフィールドにプリフィル | - | - |

#### トークン使用済みエラー

| No | テストシナリオ | 操作 | 期待される反応 | 結果 | 備考 |
|----|--------------|------|-------------|------|------|
| 1 | エラー画面表示 | 使用済みトークンで検証 | 「このリンクは既に使用されています」タイトル表示 | - | - |
| 2 | リカバリーアクション | ボタン表示 | 「新しいリンクを送信」ボタン表示 | - | - |
| 3 | ボタンクリック | ボタンをクリック | ログイン画面に遷移、メールアドレスプリフィル | - | - |

#### 無効なトークンエラー

| No | テストシナリオ | 操作 | 期待される反応 | 結果 | 備考 |
|----|--------------|------|-------------|------|------|
| 1 | エラー画面表示 | 無効なトークンで検証 | 「無効なリンクです」タイトル表示 | - | - |
| 2 | リカバリーアクション | ボタン表示 | 「ログインページに戻る」ボタン表示 | - | - |
| 3 | ボタンクリック | ボタンをクリック | ログイン画面に遷移（プリフィルなし） | - | - |

#### レート制限エラー

| No | テストシナリオ | 操作 | 期待される反応 | 結果 | 備考 |
|----|--------------|------|-------------|------|------|
| 1 | エラー画面表示 | レート制限超過 | 「リクエスト回数の上限に達しました」タイトル表示 | - | - |
| 2 | リトライ可能時刻表示 | エラー画面表示 | 「XX:XX に再度お試しください」メッセージ表示 | - | - |
| 3 | リカバリーアクション | ボタン表示 | リカバリーアクションボタンなし（時間経過待ち） | - | - |
| 4 | ホームリンク | リンク表示 | 「ホームに戻る」リンク表示 | - | - |

### テストサマリー
- **テスト項目総数**: 20
- **✅ PASS**: 0
- **❌ FAIL**: 0
- **⚠️ PARTIAL**: 0
- **🔄 未実施**: 20

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## タスク2.1.7: 視覚的回帰テスト作成・実行

### ログイン画面

| No | 状態 | スクリーンショットパス | ベースライン | 差分検出 | 結果 | 備考 |
|----|------|---------------------|------------|---------|------|------|
| 1 | デフォルト | evidence/login-default.png | - | - | - | 初期表示状態 |
| 2 | フォーカス状態 | evidence/login-focused.png | - | - | - | メールフィールドフォーカス時 |
| 3 | バリデーションエラー（空欄） | evidence/login-error-empty.png | - | - | - | 空欄送信時のエラー |
| 4 | バリデーションエラー（形式） | evidence/login-error-invalid.png | - | - | - | 不正形式メールのエラー |
| 5 | ローディング状態（短時間） | evidence/login-loading-short.png | - | - | - | 送信中、スピナーのみ |
| 6 | ローディング状態（長時間） | evidence/login-loading-long.png | - | - | - | 送信中、追加メッセージ表示 |

### メール送信確認画面

| No | 状態 | スクリーンショットパス | ベースライン | 差分検出 | 結果 | 備考 |
|----|------|---------------------|------------|---------|------|------|
| 1 | 初期表示 | evidence/email-sent-initial.png | - | - | - | カウントダウン開始状態 |
| 2 | カウントダウン中 | evidence/email-sent-countdown.png | - | - | - | カウントダウン表示中 |
| 3 | 再送信可能状態 | evidence/email-sent-resendable.png | - | - | - | カウントダウン完了後 |
| 4 | 再送信中 | evidence/email-sent-resending.png | - | - | - | 再送信ボタンクリック後 |

### トークン検証画面

| No | 状態 | スクリーンショットパス | ベースライン | 差分検出 | 結果 | 備考 |
|----|------|---------------------|------------|---------|------|------|
| 1 | 検証中（初期） | evidence/verifying-initial.png | - | - | - | スピナーとメッセージのみ |
| 2 | 検証中（プログレスバー） | evidence/verifying-progress.png | - | - | - | 3秒経過後、プログレスバー表示 |
| 3 | 検証成功 | evidence/verifying-success.png | - | - | - | 成功メッセージ表示 |

### エラー画面

| No | エラー種別 | スクリーンショットパス | ベースライン | 差分検出 | 結果 | 備考 |
|----|---------|---------------------|------------|---------|------|------|
| 1 | トークン期限切れ | evidence/error-expired.png | - | - | - | 期限切れエラー画面 |
| 2 | トークン使用済み | evidence/error-used.png | - | - | - | 使用済みエラー画面 |
| 3 | 無効なトークン | evidence/error-invalid.png | - | - | - | 無効トークンエラー画面 |
| 4 | レート制限 | evidence/error-ratelimit.png | - | - | - | レート制限エラー画面 |

### スクリーンショット取得手順

#### 環境準備
1. ローカル開発サーバーを起動
2. テスト用データベースをセットアップ
3. テスト用メールアカウントを準備

#### Playwright MCPを使用した自動取得例
```javascript
// ログイン画面 - デフォルト
mcp_playwright.navigate('http://localhost:3000/auth/login')
mcp_playwright.screenshot({
  filename: 'qa-tests/phase2/evidence/login-default.png'
})

// ログイン画面 - フォーカス状態
mcp_playwright.click({
  element: 'メールアドレスフィールド',
  ref: '[data-testid="email-input"]'
})
mcp_playwright.screenshot({
  filename: 'qa-tests/phase2/evidence/login-focused.png'
})
```

### ベースライン管理

#### ベースライン作成
- 初回テスト時に全スクリーンショットを取得
- `evidence/` ディレクトリに保存
- Gitにコミットしてベースラインとして管理

#### 差分検出方法
- 実装変更後、同じ手順でスクリーンショットを再取得
- ベースライン画像と比較
- 視覚的差分がある場合は、意図的な変更か確認

#### ベースライン更新基準
- 意図的なデザイン変更時
- レイアウト調整時
- コンポーネントの視覚的改善時

### テストサマリー
- **スクリーンショット総数**: 17
- **✅ ベースライン作成完了**: 0
- **🔄 未実施**: 17

**完了条件**: ✅/❌/⚠️/🔄
**備考**: スクリーンショット取得時はブラウザウィンドウサイズを統一（例: 1920x1080）

---

## タスク2.1.8: 要件4シナリオテスト作成・実行

### End-to-End認証フローテスト

| No | テストシナリオ | 期待される結果 | 結果 | 備考 |
|----|-------------|-------------|------|------|
| 1 | 新規ユーザーの完全な認証フロー | ログイン画面→メール送信→トークン検証→ダッシュボード | - | - |
| 2 | メールアドレス入力からマジックリンク受信 | 15分以内に有効なリンク受信 | - | - |
| 3 | マジックリンククリックから認証完了 | 3秒以内にダッシュボード表示 | - | - |
| 4 | セッション確立の確認 | ログイン状態が維持される | - | - |

### エラーケーステスト

| No | テストシナリオ | 期待される結果 | 結果 | 備考 |
|----|-------------|-------------|------|------|
| 1 | 期限切れトークンでアクセス | エラー画面表示、再送信可能 | - | - |
| 2 | 使用済みトークンでアクセス | エラー画面表示、再送信可能 | - | - |
| 3 | 無効なトークンでアクセス | エラー画面表示、ログイン画面へ戻る | - | - |
| 4 | レート制限超過 | エラー画面表示、待機時間表示 | - | - |

### タイムアウトテスト

| No | テストシナリオ | 期待される動作 | 結果 | 備考 |
|----|-------------|-------------|------|------|
| 1 | メール送信API 3秒以上 | 追加メッセージ表示 | - | - |
| 2 | トークン検証API 3秒以上 | プログレスバー表示 | - | - |
| 3 | API呼び出しタイムアウト | 適切なエラー表示 | - | - |

**完了条件**: ✅/❌/⚠️/🔄
**備考**:

---

## 検出された問題

### 重大な問題（CRITICAL）
なし

### 軽微な問題（MINOR）
なし

### 改善提案
なし

---

## 総合評価

**フェーズ2ステータス**: 🔄 未実施

**次のアクション**:
- [ ] 全APIエンドポイントのテスト実施
- [ ] UI画面コンポーネントのテスト実施
- [ ] UIインタラクションテストの実施
- [ ] 視覚的回帰テストの実施（全画面スクリーンショット取得）
- [ ] E2Eテストの実施
- [ ] 検出された問題の修正
- [ ] 修正後の再テスト

**次フェーズへの引き継ぎ事項**:
- マジックリンク認証フローが正常に動作していること
- 全エラーケースが適切に処理されること
- セッション管理の基盤が確立されていること

**対応する要件**:
- requirements.md「Story 2: マジックリンクによる認証」
- design.md「画面設計」トークン検証画面、エラー画面
- design.md「UIインタラクション設計」TokenVerifying.tsx
- design.md「APIエンドポイント」認証API

**証跡ファイル**:
- スクリーンショット: `qa-tests/phase2/evidence/`
