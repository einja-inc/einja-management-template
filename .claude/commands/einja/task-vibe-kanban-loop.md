---
description: "GitHub Issueから実行可能なタスクグループを自動選定し、Vibe-Kanbanに登録して実行を継続するループコマンド。自然言語でIssue番号、最大タスクグループ番号、ベースブランチを指定できます。"
allowed-tools: Task, Read, Write, Edit, Bash, Grep, Glob, mcp__github__*, mcp__serena__*, mcp__vibe_kanban__*, AskUserQuestion
---

# タスク自動実行ループ

このコマンドは、指定されたGitHub Issueから実行可能なタスクグループを自動的に選定し、Vibe-Kanbanに登録して実行を継続するループを実行します。

## 🚨 最重要事項

**このコマンドは「タスク選定 → タスク作成 → タスク実行 → タスク選定...」のループです。**

**絶対にやってはいけないこと**:
1. ❌ **事前に全タスクをVibe-Kanbanに作成すること**
2. ❌ **依存関係が満たされていないタスクをVibe-Kanbanに作成すること**
3. ❌ **task-starterの選定結果を無視してタスクを作成すること**

**正しい動作**:
- ✅ task-starterで「今実行できる」タスクだけを選定
- ✅ 選定されたタスクのみをVibe-Kanbanに作成
- ✅ タスク実行後、再度task-starterで選定
- ✅ これを繰り返す

## 必要な情報

ユーザーから以下の情報を**自然言語で**取得します：

1. **GitHub Issue番号**（必須）
   - 例: 「Issue #123で実行して」
   - 例: 「123」

2. **最大タスクグループ番号**（オプション）
   - **Phase番号で指定**: 「Phase 4まで」→ 4
   - **タスクグループ番号で指定**: 「タスクグループ4.2まで」→ 4.2
   - 例: 「全部実行して」→ all
   - 未指定の場合、AskUserQuestionで確認

3. **ベースブランチ**（オプション）
   - 例: 「mainブランチベースで」→ main
   - 例: 「developから作業して」→ develop
   - 例: 「feature/authブランチで」→ feature/auth
   - 未指定の場合、AskUserQuestionで確認

## 実行前の確認

コマンド実行時に以下の情報が不足している場合、**AskUserQuestionツールを使用して確認**します：

### 1. 実行範囲の確認

**⚠️ 必須**: 質問する前に必ずタスクファイルを読み込んで進捗状況を確認すること

1. **タスクファイルを読み込んで進捗状況を確認**
   - どのフェーズまで完了しているか（✅マークで判定）
   - 未完了のフェーズを特定

2. **進捗状況に基づいて動的に質問を生成**
   - 完了済みフェーズの次から選択肢を提示
   - 例: Phase 1完了済み → 「Phase 2のみ / Phase 3まで / すべて実行（推奨）」
   - ユーザーから既に指定がある場合はスキップ

### 2. Issueブランチの作成元確認

GitHub Issueから Issue番号を取得し、ブランチ名を生成して作成元を確認：

1. **Issue番号を抽出**
   - GitHub Issue: `#123`
   - Issueブランチ名: `issue/123`

2. **Issueブランチの存在確認**
   - 既に存在する場合 → そのまま使用
   - 存在しない場合 → 作成元を確認

3. **Issueブランチ作成元の確認**（ブランチが存在しない場合のみ）

   特別な指示がない場合、以下の選択肢を提示：
   ```markdown
   **質問**: Issueブランチ `issue/123` をどのブランチから作成しますか？

   **選択肢**:
   - {default_branch}（デフォルトブランチ・推奨）
   - develop
   - 現在のブランチ
   - その他のブランチ（ブランチ名を入力）
   ```

   **デフォルトブランチの取得方法**:
   ```bash
   # リモートのデフォルトブランチを取得
   git remote show origin | grep 'HEAD branch' | awk '{print $NF}'
   ```

4. **タスクブランチの作成**（必要な場合）
   ```bash
   git checkout {source_branch}
   git pull origin {source_branch}
   git checkout -b feat/monorepo/20251104-turborepo-setup
   git push -u origin feat/monorepo/20251104-turborepo-setup
   ```

### 3. フェーズブランチの自動作成

実行対象の各フェーズについて、フェーズブランチを自動作成：

1. **フェーズブランチ名を生成**
   - 形式: `feat/{ディレクトリ}/{タスク名}-phase{N}`
   - 例: `feat/monorepo/20251104-turborepo-setup-phase1`

2. **フェーズブランチの存在確認と作成**
   - 存在しない場合 → タスクブランチから作成してプッシュ
     ```bash
     git checkout feat/monorepo/20251104-turborepo-setup
     git checkout -b feat/monorepo/20251104-turborepo-setup-phase1
     git push -u origin feat/monorepo/20251104-turborepo-setup-phase1
     ```
   - 既に存在する場合 → そのまま使用

3. **フェーズブランチをベースブランチとして使用**
   - Phase 1タスク → `feat/monorepo/20251104-turborepo-setup-phase1`
   - Phase 2タスク → `feat/monorepo/20251104-turborepo-setup-phase2`

**詳細**: ブランチ運用の詳細は [ブランチ運用戦略](../../docs/steering/branch-strategy.md) を参照

## 処理フロー

### 0. 初期化フェーズ（最初のみ実行）

1. **ユーザー入力の解析**
   - タスクファイルパスを自然言語から抽出
   - 最大タスク番号を自然言語から抽出（あれば）

2. **不足情報の確認**
   - **タスクファイルを読み込んで進捗状況を確認**（必須）
   - 最大タスク番号が未指定の場合 → 進捗状況に基づいて動的に質問生成

3. **タスクファイルパスからブランチ名を生成**
   - ディレクトリとタスク名を抽出
   - タスクブランチ名を生成: `feat/{ディレクトリ}/{タスク名}`
   - フェーズブランチ名を生成: `feat/{ディレクトリ}/{タスク名}-phase{N}`

4. **タスクブランチの確認と作成**
   - タスクブランチが存在するか確認
   - 存在しない場合 → 作成元を確認（デフォルト: main）
   - タスクブランチを作成してプッシュ

5. **フェーズブランチの確認と作成**
   - 実行対象の各フェーズについて、フェーズブランチを確認
   - 存在しない場合 → タスクブランチから作成してプッシュ

6. **設定の表示**
   ```markdown
   📋 タスク実行設定:
   - タスクファイル: {task_file_path}
   - 最大タスク番号: {max_task_number}（または「全タスク」）
   - タスクブランチ: feat/{ディレクトリ}/{タスク名}（新規作成 / 既存）
   - 実行フェーズ: Phase {N}まで
   - フェーズブランチ: feat/{ディレクトリ}/{タスク名}-phase{N}
   ```

以下の処理をループで繰り返し実行します：

### 1. 最新タスク状態取得フェーズ

**⚠️ 重要**: リモートのベースブランチから最新のタスクファイルを取得して、タスクの完了状態を確認します。

1. **リモート情報を更新**
   - `git fetch origin` を実行

2. **リモートのベースブランチからタスクファイルを取得**
   - `git show origin/{base_branch}:{task_file_path}` でタスクファイルの内容を取得
   - このファイル内容をtask-starterに渡してタスク選定を行う

3. **取得成功を確認**
   - ファイル取得が成功したら、次のタスク選定フェーズに進む
   - ファイルが存在しない場合は、ローカルのタスクファイルを使用

### 2. タスク選定フェーズ

**⚠️ 重要**: このコマンド内でタスクファイルを読んで未完了タスクを確認する必要はありません。**すべてtask-starterサブエージェントに任せてください。**

**絶対にやってはいけないこと**:
- ❌ **コマンド実行者がタスクファイルを読んで未完了タスクを手動で確認すること**
- ❌ **タスクファイルの内容を解析して依存関係を手動でチェックすること**

**正しい動作**:
- ✅ task-starterサブエージェントを呼び出すだけ
- ✅ task-starterの選定結果を信頼して使用する
- ✅ コマンド実行者は選定結果に基づいてVibe-Kanbanタスクを作成するだけ

task-starterサブエージェント（haiku モデル）を使用してタスクを選定：

**🚨 重要: タスク粒度の基本原則**
- **デフォルトはタスクグループ単位**（例: 4.1全体 = 4.1.1, 4.1.2, 4.1.3をまとめて選定）
- 個別タスク単位（例: 4.1.1のみ）での選定は**例外的な場合のみ**

**選定ロジック**:
- 選定されるタスク数は自然言語指示から自動判断
- 粒度指定（「1-1, 1-2の粒度でタスク作成」など）がある場合、各中カテゴリ（サブフェーズ）ごとに実行可能な全タスクを選定
- 明示的なタスク指定がある場合（「タスク4.1.1のみ実行」など）、指定された数だけ選定
- **指定がない場合（デフォルト）、最も優先度の高い1タスクグループ**（タスクグループ内の全タスクをまとめて）を選定
  - 例: タスクグループ4.1が実行可能 → 4.1.1, 4.1.2, 4.1.3をまとめて選定
  - 例: タスクグループ4.1が未完了で4.2が実行可能 → 4.2.1, 4.2.2, 4.2.3をまとめて選定

**選定結果の判定**:
- task-starterが「実行可能なタスクあり」と判定 → 3. タスク実行フェーズへ
- task-starterが「実行可能なタスクなし」と判定 → 4. 完了・待機フェーズへ

### 3. タスク実行フェーズ

**🚨 このフェーズは、task-starterが「実行可能なタスクあり」と判定した場合のみ実行**

**絶対に守ること**:
- ❌ **依存関係が満たされていないタスクのVibe-Kanbanタスクを作成してはいけません**
- ❌ **task-starterの選定結果を無視してタスクを作成してはいけません**
- ❌ **タスクファイルの全未完了タスクを一度に作成してはいけません**
- ✅ **task-starterが選定したタスクのみを作成**
- ✅ **task-starterが「実行可能なタスクなし」の場合、このフェーズはスキップして待機フェーズへ移行**

1. **Vibe-Kanbanにタスクを作成**（task-starterが選定したタスクグループのみ）

   **選定タスクグループが1個の場合**（デフォルト）:

   - タイトル形式: `/task-exec <タスクグループ番号> <タスクグループ名>`
     - 例: `/task-exec 4.1 Turborepoビルドパイプライン最適化`
     - これはタスク4.1.1, 4.1.2, 4.1.3をまとめて実行することを意味します
     - `/task-exec` プレフィックスは**必須**です
   - 説明:
     ```
     ## タスクファイル
     `<タスクファイルパス>`

     ## タスクグループ番号
     <タスクグループ番号>（例: 4.1）

     ## タスク一覧

     ### タスク<X.Y.Z>: <タスク名>
     <tasks.mdから抽出したサブタスク一覧>

     （タスクグループ内の全タスクを列挙）
     ```

   **選定タスクグループが複数の場合**:

   - タイトル形式: `/task-exec <タスクグループ番号1>, <タスクグループ番号2>, ... <グループ名>`
     - 例: `/task-exec 4.1, 4.2 Phase 4 ビルド最適化タスク`
     - グループ名は粒度指定から生成、または「まとめて実装」など
   - 説明:
     ```
     ## タスクファイル
     `<タスクファイルパス>`

     ## タスクグループ番号
     <タスクグループ番号1>, <タスクグループ番号2>

     ## タスク詳細

     ### タスクグループ<タスクグループ番号1>: <タスクグループ名1>
     <tasks.mdから抽出したタスク一覧とサブタスク1>

     ### タスクグループ<タスクグループ番号2>: <タスクグループ名2>
     <tasks.mdから抽出したタスク一覧とサブタスク2>
     ```

   **実装時の注意**: `mcp__vibe_kanban__create_task` を呼び出す際、titleパラメータには必ず `/task-exec ` で始まる文字列を渡すこと

2. **ステータスを "in-progress" に更新**
   - `mcp__vibe_kanban__update_task` を使用
   - status パラメータには `"in-progress"` を指定（ハイフン区切り）

3. **タスクの実行を開始**
   - `mcp__vibe_kanban__start_task_attempt` を呼び出し
   - executor: CLAUDE_CODE
   - base_branch: **タスクが属するフェーズのフェーズブランチ**
     - 例: Phase 1のタスク → `feat/monorepo/20251104-turborepo-setup-phase1`
     - 例: Phase 2のタスク → `feat/monorepo/20251104-turborepo-setup-phase2`
   - 実行試行IDを取得
   - **重要**: GitHub Issueは更新しない（エージェントが完了時に自動更新する）

4. **タスク開始成功時の処理**
   - 待機試行カウンターをリセット（0に戻す）
   - **即座に2. タスク選定フェーズに戻る**
   - **⚠️ 重要**:
     - 次のタスクを事前に作成してはいけません。必ずタスク選定フェーズから開始してください
     - **task-executer、task-reviewer、task-qa、task-finisherなどのタスク実行サブエージェントを呼び出してはいけません**
     - **タスクの実際の実行はVibe-Kanban側が自動的に処理します**
     - **このコマンドの役割はタスクの選定とVibe-Kanban登録のみです**

### 4. 完了・待機フェーズ

#### 4.1 最大タスク番号に到達した場合

- メッセージを出力:
  ```
  ✅ 指定された最大タスク番号 {max_task_number} まで完了しました！

  実行されたタスク: {completed_count}個

  ループを終了します。
  ```
- ループを終了

#### 4.2 選定されたタスクがない場合（最大タスク番号未到達）

1. **待機試行カウンターを確認**
   - 待機試行回数が30回に達した場合:
     ```
     ⚠️ 30回の待機試行後も実行可能なタスクが見つかりませんでした。

     最後に実行されたタスク番号: {last_task_number}
     実行完了タスク数: {completed_count}個

     ループを終了します。
     ```
   - ループを終了

2. **2分間待機（必ず120秒）**
   - 待機試行カウンターを +1 する
   - メッセージを出力: "実行可能なタスクがありません。2分後に再試行します...（試行 {current_retry}/{max_retry}）"
   - **⚠️ 重要**: 待機時間は必ず120秒です。60秒や300秒など他の値に変更してはいけません
   - `sleep 120` コマンドを使用

3. **ステップ1（最新タスク状態取得フェーズ）に戻る**
   - 再度リモートから最新のタスクファイルを取得してタスク選定を試みる
   - **⚠️ 重要**: 実行できないタスクを事前に作成してはいけません

## 技術仕様

### サブエージェント設定
```
subagent_type: task-starter
model: haiku  # コスト削減のため軽量モデルを使用
```

### 使用ツール
- **タスク読み取り**: GitHub MCP（GitHub Issueからタスク一覧を読み取り）
- **Vibe-Kanban操作**:
  - `mcp__vibe_kanban__create_task`
  - `mcp__vibe_kanban__update_task`
  - `mcp__vibe_kanban__start_task_attempt`

**注意**: GitHub Issueの書き込みは行わない（実行エージェントが完了時に自動更新）

## 使用例

### 例1: 最小限の指定（対話形式）

```
/task-vibe-kanban-loop monorepoのタスクファイルで実行して
```

実行時にシステムが確認：
- どこまでのタスクを実行しますか？ → 「すべてのタスクを実行」を選択
- タスクブランチをどのブランチから作成しますか？ → 「{default_branch}（デフォルトブランチ・推奨）」を選択

自動的に以下のブランチが作成されます：
- タスクブランチ: `feat/monorepo/20251104-turborepo-setup`（デフォルトブランチから作成）
- フェーズブランチ: `feat/monorepo/20251104-turborepo-setup-phase1`（タスクブランチから作成）

→ **各タスクグループを1個ずつ選定**して、該当フェーズブランチで実行（デフォルト動作）
  - 例: タスクグループ1.1（1.1.1, 1.1.2, ..., 1.1.15）をまとめて1つのVibe-Kanbanタスクとして実行
  - 次にタスクグループ1.2（1.2.1, 1.2.2, ..., 1.2.4）をまとめて実行

### 例2: Phase指定で実行

```
/task-vibe-kanban-loop monorepoのタスクファイルでPhase 4まで実行
```

タスクグループ4.Xまで（Phase 4完了確認まで）を実行

自動的に以下のブランチが作成されます：
- タスクブランチ: `feat/monorepo/20251104-turborepo-setup`（デフォルトブランチから作成）
- フェーズブランチ: `feat/monorepo/20251104-turborepo-setup-phase4`（タスクブランチから作成）

→ 各タスクグループを1個ずつ選定して、phase4ブランチで実行

### 例3: タスクグループ指定で実行

```
/task-vibe-kanban-loop monorepoのタスクファイルでタスクグループ4.2まで実行
```

タスクグループ4.2まで実行

自動的に以下のブランチが作成されます：
- タスクブランチ: `feat/monorepo/20251104-turborepo-setup`（デフォルトブランチから作成）
- フェーズブランチ: `feat/monorepo/20251104-turborepo-setup-phase4`（タスクブランチから作成）

→ タスクグループ4.1、4.2を順次実行

### 例4: 個別タスク番号指定で実行（例外的な場合のみ）

```
/task-vibe-kanban-loop monorepoのタスクファイルでタスク4.1.2まで実行
```

タスク4.1.2まで実行（タスクグループ4.1内のタスク4.1.1、4.1.2が完了したら停止）

**⚠️ 注意**: 個別タスク番号指定は例外的な場合のみ使用してください
- デフォルトはタスクグループ単位（4.1全体）での実行です
- より細かい粒度での制御が必要な特殊な状況でのみ使用

### 例5: タスクブランチの作成元を指定

```
/task-vibe-kanban-loop authタスクを全部実行して
```

実行時にシステムが確認：
- タスクブランチをどのブランチから作成しますか？ → 「develop」を選択

自動的に以下のブランチが作成されます：
- タスクブランチ: `feat/auth/20251105-magic-link`（**developから作成**）
- フェーズブランチ: `feat/auth/20251105-magic-link-phase1`（タスクブランチから作成）
- フェーズブランチ: `feat/auth/20251105-magic-link-phase2`（タスクブランチから作成）

→ **各タスクグループを1個ずつ選定**して、該当フェーズブランチで実行

## 重要な識別情報の記録

### プロジェクト情報
Vibe-Kanbanでタスクを管理する際に必要な情報：

```markdown
## Vibe-Kanban プロジェクト情報

**プロジェクトID**: `<project_id>`
**プロジェクト名**: `<project_name>`

## 作成されたタスク一覧

| タスクグループ番号 | タスクグループ名 | Vibe-Kanban タスクID | ステータス | 作成日時 |
|-----------|---------|---------------------|----------|---------|
| 4.1 | Turborepoビルドパイプライン最適化 | `<task_id>` | in-progress | YYYY-MM-DD HH:MM |
| 4.2 | リモートキャッシュ設定 | `<task_id>` | todo | YYYY-MM-DD HH:MM |

## タスク実行試行情報

| タスクグループ番号 | 試行ID | Executor | Base Branch | 開始日時 |
|-----------|--------|----------|-------------|---------|
| 4.1 | `<attempt_id>` | CLAUDE_CODE | main | YYYY-MM-DD HH:MM |
```

### 記録すべき情報

1. **プロジェクトID** (`project_id`)
   - `mcp__vibe_kanban__list_projects` で取得
   - 全タスク操作で必要

2. **タスクID** (`task_id`)
   - `mcp__vibe_kanban__create_task` のレスポンスから取得
   - タスク更新・削除時に必要

3. **タスク実行試行ID** (`attempt_id`)
   - `mcp__vibe_kanban__start_task_attempt` のレスポンスから取得
   - 実行状況の追跡に使用

### 情報の取得方法

```javascript
// プロジェクト一覧取得
const projects = await mcp__vibe_kanban__list_projects({});
// => プロジェクトID: projects.data[0].id

// タスク作成
const task = await mcp__vibe_kanban__create_task({
  project_id: "<project_id>",
  title: "1.1.1 プロジェクトルート初期化",
  description: "..."
});
// => タスクID: task.id

// タスク実行開始
const attempt = await mcp__vibe_kanban__start_task_attempt({
  task_id: "<task_id>",
  executor: "CLAUDE_CODE",
  base_branch: "main"
});
// => 試行ID: attempt.id
```

## 注意事項

**⚠️ 厳守事項**:
1. **待機時間は必ず120秒**: `sleep 120` を使用。60秒や300秒など他の値に変更してはいけません
2. **実行可能なタスクのみ作成**: 依存関係が満たされていないタスクのVibe-Kanbanタスクを事前に作成してはいけません
3. **タスク開始後は即座にタスク選定へ**: 次のタスクを事前に作成せず、必ずタスク選定フェーズから開始します
4. **完了報告で止まらない**: タスク完了を確認したら、報告だけで止まらず、即座に次のタスク選定フェーズに進みます

- **最大タスク番号が指定されている場合、その番号に到達したらループを自動終了します**
- **最大タスク番号が `all` の場合、すべてのタスクが完了するまで継続します（手動停止が必要）**
- **待機試行回数の上限は30回です**
  - 実行可能なタスクがない場合、**必ず2分間（120秒）**待機して再試行します
  - タスクが見つからない状態で30回待機した場合、ループを自動終了します
  - タスクの実行開始に成功した場合、待機試行カウンターは0にリセットされます
- task-starterサブエージェントは軽量なhaikuモデルを使用してコストを削減します
- **GitHub Issueの書き込みは行わない**（実行エージェントが完了時に自動更新するため）
- タスクの読み取りにはGitHub MCPツール（`mcp__github__get_issue`など）を使用してください
- Vibe-KanbanのプロジェクトIDは`mcp__vibe_kanban__list_projects`で取得します
- **タスク作成時は必ず返却されたIDを記録し、後続の操作で使用してください**
- **タスクブランチの作成元は初期化時に1度だけ確認します（デフォルト: リモートのデフォルトブランチを自動取得）**
- **各タスクは属するフェーズのフェーズブランチをベースブランチとして実行します**
- **粒度指定がある場合、指定された粒度（Phase/タスクグループ/タスク）に応じて実行可能なタスクをまとめて1つのVibe-Kanbanタスクとして作成します**
- **複数タスクをまとめて実行する場合、Vibe-Kanbanタスクのタイトルには `/task-exec <タスク番号1>, <タスク番号2>, ... <グループ名>` 形式を使用します**

## タスク番号の比較ルール

タスク番号（例: `1.2.3`）を比較して実行範囲を判定します：

- タスク番号をドット区切りで分割し、左から順に数値として比較
- 各セグメントを比較し、小さければ実行対象、大きければ対象外
- 完全一致の場合も実行対象

**比較例**:
- `1.2.3` と最大 `1.2.5` → 実行対象（メジャー・マイナーが同じで、パッチが小さい）
- `1.2.5` と最大 `1.2.5` → 実行対象（完全一致）
- `1.2.6` と最大 `1.2.5` → 実行対象外（パッチが大きい）
- `1.3.1` と最大 `1.2.5` → 実行対象外（マイナーが大きい）
- `2.1.1` と最大 `1.2.5` → 実行対象外（メジャーが大きい）
