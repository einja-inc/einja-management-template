# タスクグループ1.4: syncコマンド実装と基本同期フロー - 修正記録

## 実装日
2026-01-04

## タスク概要
- **タスクグループ**: 1.4
- **タスク名**: syncコマンド実装と基本同期フロー
- **Issue番号**: #21

## 新規作成ファイル

### 1. packages/cli/src/lib/sync/backup-manager.ts
- **目的**: 同期前のファイルバックアップとリストア機能を提供
- **主な機能**:
  - ファイル/複数ファイルのバックアップ
  - バックアップファイルのリストア
  - 古いバックアップのクリーンアップ
  - バックアップディレクトリ管理（`.einja-sync-backups`）

### 2. packages/cli/src/commands/sync.ts
- **目的**: syncコマンドのエントリーポイント
- **主な機能**:
  - テンプレートとプロジェクトの差分計算
  - 3方向マージによるローカル変更保持
  - コンフリクト検出とレポート
  - バックアップ管理
  - オプション処理（--dry-run, --force, --only, --yes, --json, --backup）
- **統合モジュール**:
  - MetadataManager: メタデータ管理
  - FileFilter: 同期対象ファイルのスキャン
  - DiffEngine: 3方向マージ
  - ConflictReporter: コンフリクト報告
  - BackupManager: バックアップ管理

### 3. packages/cli/src/lib/sync/backup-manager.test.ts
- **目的**: BackupManagerクラスのユニットテスト
- **テスト項目**:
  - ファイルバックアップ（12テスト）
  - 複数ファイルバックアップ
  - リストア処理
  - 古いバックアップのクリーンアップ
  - バックアップディレクトリ管理

### 4. packages/cli/src/commands/sync.test.ts
- **目的**: syncコマンドの統合テスト
- **テスト項目**（6テスト）:
  - AC1.1: 基本的なテンプレート同期
  - AC1.2: 更新不要時のメッセージ
  - AC1.3: 3方向マージによるローカル変更保持
  - オプション処理（--dry-run, --force, --only）

## 編集ファイル

### 1. packages/cli/src/types/index.ts
- **変更内容**: SyncOptions型定義を追加
- **追加型**:
  ```typescript
  export interface SyncOptions {
    only?: string;
    dryRun?: boolean;
    force?: boolean;
    yes?: boolean;
    json?: boolean;
    backup?: boolean;
  }
  ```

### 2. packages/cli/src/cli.ts
- **変更内容**: syncコマンドを登録
- **追加内容**:
  - syncCommandのインポート
  - syncコマンドの定義とオプション設定

### 3. packages/cli/src/lib/sync/metadata-manager.ts
- **変更内容**: calculateHashメソッドをpublicに変更
- **理由**: syncコマンドから差分計算時にハッシュ計算が必要なため

## 削除ファイル
なし

## 実装メモ

### 使用技術
- **Node.js組み込みモジュール**: crypto (SHA-256ハッシュ計算), path, os
- **外部ライブラリ**:
  - fs-extra: ファイル操作
  - chalk: コンソール出力の色付け
  - ora: スピナー表示
  - inquirer: 対話的プロンプト
  - node-diff3: 3方向マージ

### 重要な設計決定

1. **テンプレートルートの取得**
   - ESモジュール環境での`__dirname`取得にfileURLToPathを使用
   - テンプレートルート: `packages/cli/presets/turborepo-pandacss`

2. **バックアップディレクトリ**
   - プロジェクトルート直下の`.einja-sync-backups`に保存
   - タイムスタンプ付きファイル名でバージョン管理

3. **3方向マージフロー**
   - ベース版: 前回同期時のテンプレート版（メタデータから取得）
   - ローカル版: 現在のプロジェクトファイル
   - テンプレート版: 最新のテンプレートファイル
   - node-diff3ライブラリで自動マージ

4. **コンフリクト処理**
   - コンフリクト発生時は標準的なマーカー形式で保存
   - `<<<<<<< LOCAL`, `=======`, `>>>>>>> TEMPLATE`
   - ConflictReporterで詳細レポート生成

5. **エラーハンドリング**
   - 各ステップでoraスピナーを使用した進捗表示
   - エラー発生時は適切なメッセージを表示

### テスト戦略
- **BackupManager**: 12テスト（ファイル操作、バックアップ/リストア）
- **syncCommand**: 6テスト（AC検証、オプション処理）
- **全体**: 74テスト合格（既存テスト含む）

### 品質保証
- ✅ TypeScript strict mode準拠
- ✅ any型不使用
- ✅ Biome lintエラーゼロ
- ✅ 全テスト合格（74/74）

## 受け入れ基準の達成状況

### AC1.1: 基本的なテンプレート同期 ✅
- テンプレート最新版との差分をマージ
- 成功メッセージを表示

### AC1.2: 更新不要時のメッセージ ✅
- "すでに最新です"のメッセージ表示
- ファイル変更なし

### AC1.3: 3方向マージによるローカル変更保持 ✅
- DiffEngineによる3方向マージ実装
- コンフリクトなし時は両方の変更を保持
- コンフリクト時はマーカー付きで保存

## QA修正記録

### QAで検出された問題（2026-01-04）

**分類**: C - 設計不備（アーキテクチャの問題）

**問題の詳細**:
設計書（`design/implementation.md`）では同期対象ディレクトリとして以下を定義：
```
- .claude/commands/einja/
- .claude/agents/einja/
- .claude/skills/einja/
- docs/einja/
```

しかし、実際のプリセット（`presets/turborepo-pandacss/`）には`einja/`サブディレクトリが存在せず、以下の構造になっていた：
```
presets/turborepo-pandacss/
├── commands/          # einja/なし
├── agents/            # einja/なし
└── preset.yaml
```

この不一致により、`FileFilter.ts`の`scanSyncTargets()`が0件のファイルを検出し、syncコマンドが実質的に動作しなかった。

### 修正内容

#### 1. プリセット構造の変更

**実行コマンド**:
```bash
cd packages/cli/presets/turborepo-pandacss
mkdir -p .claude/commands/einja .claude/agents/einja .claude/skills/einja docs/einja
mv commands/* .claude/commands/einja/
mv agents/* .claude/agents/einja/
rmdir commands agents
```

**変更後の構造**:
```
presets/turborepo-pandacss/
├── .claude/
│   ├── commands/
│   │   └── einja/              # ファイルを移動
│   ├── agents/
│   │   └── einja/              # ファイルを移動
│   └── skills/
│       └── einja/              # 空ディレクトリ作成
├── docs/
│   └── einja/                  # 空ディレクトリ作成
└── preset.yaml
```

#### 2. initコマンドのプリセット読み込みパス更新

**ファイル**: `packages/cli/src/lib/merger.ts`

**変更箇所**:
```typescript
// 3. プリセット固有のファイルをコピー（einja/サブディレクトリから）
const presetAgentsPath = path.join(presetPath, ".claude", "agents", "einja");
if (await fs.pathExists(presetAgentsPath)) {
	await copyAndProcessDirectory(
		presetAgentsPath,
		path.join(targetPath, "agents", "einja"),
		presetConfig.variables,
	);
}

const presetCommandsPath = path.join(presetPath, ".claude", "commands", "einja");
if (await fs.pathExists(presetCommandsPath)) {
	await copyAndProcessDirectory(
		presetCommandsPath,
		path.join(targetPath, "commands", "einja"),
		presetConfig.variables,
	);
}

const presetSkillsPath = path.join(presetPath, ".claude", "skills", "einja");
if (await fs.pathExists(presetSkillsPath)) {
	await copyAndProcessDirectory(
		presetSkillsPath,
		path.join(targetPath, "skills", "einja"),
		presetConfig.variables,
	);
}
```

**追加機能**:
- `skills`カテゴリのサポートを追加

### 修正後のテスト結果

**全テスト**: ✅ 74/74 合格
```
✓ src/lib/sync/file-filter.test.ts (11 tests) 31ms
✓ src/lib/sync/conflict-reporter.test.ts (9 tests) 3ms
✓ src/lib/sync/diff-engine.test.ts (11 tests) 4ms
✓ src/lib/sync/integration.test.ts (14 tests) 4ms
✓ src/commands/sync.test.ts (6 tests) 14ms
✓ src/lib/sync/backup-manager.test.ts (12 tests) 19ms
✓ src/lib/sync/metadata-manager.test.ts (11 tests) 10ms
```

**Lint**: ✅ エラーなし
**Type Check**: ✅ エラーなし
**Build**: ✅ 成功

### 修正の影響範囲

**修正されたファイル**:
- `packages/cli/presets/turborepo-pandacss/` - ディレクトリ構造変更
- `packages/cli/src/lib/merger.ts` - プリセット読み込みパスの更新

**影響を受ける機能**:
- ✅ initコマンド: 新しいプリセット構造から正しくファイルを読み込む
- ✅ syncコマンド: FileFilterが新しいプリセット構造からファイルを検出可能

### 完了条件の確認

- ✅ プリセット構造が設計書の仕様に準拠している
- ✅ syncコマンドが同期対象ファイルを正しく検出する
- ✅ initコマンドが引き続き正常に動作する
- ✅ 全てのテストが合格する

## 次のステップ
- タスク1.5: コンフリクト解決ワークフロー実装
- タスク1.6: カテゴリ別同期とフィルタリング機能
