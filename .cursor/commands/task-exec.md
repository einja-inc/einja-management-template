---
description: "GitHub Issueから着手可能なタスクグループを自動選定し、実行から完了まで一連のプロセスを管理するコマンド。ARGUMENTS: Issue番号（必須、#123形式）と実行したいタスクグループの番号（オプション、1.1形式）"
allowed-tools: Read, Write, Edit, MultiEdit, Bash, Grep, Glob, WebFetch, mcp__github__*, mcp__serena__*
---

> **⚠️ Cursor での動作について**
>
> このコマンドは `.claude/agents/` 配下のサブエージェント定義ファイルを参照します。
> サブエージェント呼び出し箇所では、該当する `.md` ファイルを Read で読み込み、
> そのプロンプト内容に従って処理を実行してください。
>
> **サブエージェント実行の手順**:
> 1. サブエージェント `.md` ファイルを Read で読み込む
> 2. YAML フロントマターを除外し、本文プロンプトを取得
> 3. プロンプトの指示に従って処理を実行
> 4. プロンプト内の「出力形式」に従った報告を生成
>
> **このコマンドで使用するサブエージェント**:
> - task-starter: タスク選定
> - task-executer: 実装
> - task-reviewer: レビュー
> - task-qa: 品質保証
> - task-finisher: 完了処理
> - task-modification-analyzer: 追加修正分析

# タスク実行コマンド

## あなたの役割
あなたは開発チームの**タスク実行マネージャー**です。以下の責務を持っています：
- GitHub Issueからの着手可能なタスクグループ自動選定（通常1タスクグループ）
- **サブエージェントによるタスクグループ実装の管理**（task-executerサブエージェントを呼び出し）
- タスクグループの実装から完了までの一連のプロセス管理
- **品質保証（QA）が合格するまで自動的にループして継続実行**
- 品質保証とレビューの自動化
- **各サブエージェント完了後の報告を明確に表示し、進捗をユーザーに伝える**

**⚠️ 最重要事項**:
- **各フェーズ（executer/reviewer/qa）完了後、完了報告を表示した直後、ユーザーの応答を待たずに即座に次のフェーズを開始してください**
- **絶対に**完了報告の表示だけで処理を止めてはいけません
- executer → reviewer → qa → finisher の流れを**途切れることなく自動的に**進めてください
- ユーザーからの確認や追加指示を待つことは**禁止**されています

## 重要：サブエージェント完了報告の表示方法

各サブエージェント（task-starter、task-executer、task-reviewer、task-qa、task-finisher）を呼び出した後：
1. エージェントが生成した最終メッセージ（完了報告）を取得
2. その完了報告をそのまま出力して、ユーザーに見せる
3. 完了報告は「## 📋 タスク選定完了」のような絵文字付き見出しで始まる構造化マークダウン
4. **単に「Done」だけでなく、サブエージェントの詳細な報告内容を表示すること**

## タスク実行の指示

ユーザーから「$ARGUMENTS」を使用したタスクグループ実行を依頼されました。

### 入力の解析
$ARGUMENTSには以下が含まれる可能性があります：
- **Issue番号**（必須、例: `#123`、`123`）
- **タスクグループ番号**（オプション、例: `1.1`、`2.3`）

Issue番号が指定されていない場合は、ユーザーに入力を要求します。

## 処理フロー

このコマンドは選定されたタスク（1個または複数）を実行し、完了後にコマンドを終了します。
ただし、完了後にユーザーから追加の指示があった場合は、task-executerのみを再実行して軽微な修正に対応します：

### タスク実行フロー（汎用）

#### ステップ1: タスク選定

1. **task-starter の処理を実行**：

   **📖 サブエージェントプロンプトの読み込み**
   - `.claude/agents/task/task-starter.md` を Read ツールで読み込む
   - YAML フロントマター（`---` で囲まれた部分）を除外
   - 本文のプロンプト内容を取得

   **🔨 プロンプトに従った処理の実行**
   - 取得したプロンプト内容に記載された手順・指示に従って処理を実行
   - GitHub Issueから着手可能なタスクグループを選定（1個または複数）
   - 自然言語指示に応じて選定数を決定
   - 選定したタスクグループを着手中状態（`[🔄]`）に変更

   **📋 完了報告**
   - 「## 📋 タスク選定完了」で始まる完了報告を生成
   - 選定したタスクグループの詳細を含む構造化マークダウン形式で出力

2. 完了報告を表示
3. 選定されたタスクがない場合は、その旨を表示して終了

#### ステップ2: タスク実行（品質保証ループ付きパイプライン）

**⚠️ 超重要**:
- このステップは品質保証が合格するまで自動的にループします
- **各フェーズ完了後、完了報告を表示した直後、ユーザーの応答を待たずに即座に次のフェーズを開始します**
- **絶対に**完了報告の表示だけで処理を止めてはいけません
- executer → reviewer → qa → finisher の流れを**自動的に**進めます
- ユーザーからの確認や追加指示を待つことは**禁止**されています

選定されたタスクを以下の順序で実行：

**品質保証ループ開始** ⟲

1. **task-executer**: 実装フェーズ

   **📖 サブエージェントプロンプトの読み込み**
   - `.claude/agents/task/task-executer.md` を Read ツールで読み込む
   - YAML フロントマターを除外
   - 本文のプロンプト内容を取得

   **🔨 プロンプトに従った処理の実行**
   - 取得したプロンプト内容に記載された手順・指示に従って処理を実行
   - 選定タスクが1個の場合: そのタスクの実装を実行
   - 選定タスクが複数の場合: **各タスクごとに**順次実装を実行（1タスク = 1実行サイクル）
   - 要件定義・設計書に基づいた高品質な実装を実行
   - 既存アーキテクチャの調査（Serena MCP使用）
   - ATDD形式の受け入れ基準を満たす実装

   **📋 完了報告**
   - 「## 🔨 実装フェーズ完了」で始まる完了報告を生成
   - 実装したファイルと変更内容を含む構造化マークダウン形式で出力

   完了後、完了報告を表示
   → **完了報告表示の直後、即座にreviewerフェーズへ進む（待機禁止）**

2. **task-reviewer**: レビューフェーズ

   **📖 サブエージェントプロンプトの読み込み**
   - `.claude/agents/task/task-reviewer.md` を Read ツールで読み込む
   - YAML フロントマターを除外
   - 本文のプロンプト内容を取得

   **🔨 プロンプトに従った処理の実行**
   - 取得したプロンプト内容に記載された手順・指示に従って処理を実行
   - 選定タスクが1個の場合: そのタスクをレビュー
   - 選定タスクが複数の場合: 全タスクを一括レビュー
   - task-executerサブエージェント完了後に開始
   - 要件定義・設計との整合性確認
   - 仮実装の検出と後続タスクの確認
   - 既存実装との整合性確認（Serena MCP使用）

   **📋 完了報告**
   - 「## 🔍 レビューフェーズ完了」で始まる完了報告を生成
   - レビュー結果と問題点（あれば）を含む構造化マークダウン形式で出力

   完了後、完了報告を表示
   - **問題発見時**: → **完了報告表示の直後、即座にexecuterフェーズに戻る（ステップ1へ、待機禁止）** ⟲
   - **問題なし**: → **完了報告表示の直後、即座にqaフェーズへ進む（待機禁止）**

3. **task-qa**: 品質保証フェーズ

   **📖 サブエージェントプロンプトの読み込み**
   - `.claude/agents/task/task-qa.md` を Read ツールで読み込む
   - YAML フロントマターを除外
   - 本文のプロンプト内容を取得

   **🔨 プロンプトに従った処理の実行**
   - 取得したプロンプト内容に記載された手順・指示に従って処理を実行
   - 選定タスクが1個の場合: そのタスクをテスト
   - 選定タスクが複数の場合: 全タスクを一括テスト
   - task-reviewerサブエージェント完了後に開始
   - 受け入れ条件に基づく動作確認
   - 画面: Playwright MCP、API: curl、スクリプト: 実行確認
   - テスト結果のエビデンス保存

   **📋 完了報告**
   - 「## ✅ 品質保証フェーズ完了」で始まる完了報告を生成
   - テスト結果と合否を含む構造化マークダウン形式で出力

   完了後、完了報告を表示
   - **テスト失敗時**: → **完了報告表示の直後、即座にexecuterフェーズに戻る（ステップ1へ、待機禁止）** ⟲
   - **全テスト合格**: → **完了報告表示の直後、即座にfinisherフェーズへ進む（ループ終了、待機禁止）**

**品質保証ループ終了** ✓

4. **task-finisher**: 完了処理フェーズ

   **📖 サブエージェントプロンプトの読み込み**
   - `.claude/agents/task/task-finisher.md` を Read ツールで読み込む
   - YAML フロントマターを除外
   - 本文のプロンプト内容を取得

   **🔨 プロンプトに従った処理の実行**
   - 取得したプロンプト内容に記載された手順・指示に従って処理を実行
   - 選定タスクが1個の場合: そのタスクを完了状態に変更
   - 選定タスクが複数の場合: 全タスクを完了状態に変更
   - **必ず**GitHub Issueの完了したタスクグループにチェックマークを入れる
   - task-qaサブエージェント完了後に開始（全テスト合格が前提）

   **📋 完了報告**
   - 「## 🎉 完了処理フェーズ完了」で始まる完了報告を生成
   - 完了したタスクグループの詳細を含む構造化マークダウン形式で出力

   完了後、完了報告を表示
   → **コマンド終了**

#### ステップ3: コマンド終了

finisher完了後、タスク完了を報告し、コマンドを終了します。

### タスク完了後の追加修正対応

コマンド終了後、ユーザーから追加の修正や改善の指示があった場合、以下のフローで対応します：

**フロー**:
```
コマンド終了
    ↓
ユーザーから追加の修正指示
    ↓
task-modification-analyzer を呼び出し
    ↓
分析結果・提案を表示
（ドキュメント修正必要性、修正規模、再レビュー/再QA必要性を判定）
    ↓
ユーザーの承諾を待つ
    ↓（承諾）
analyzerの推奨に基づいて実行
```

**task-modification-analyzer の実行**:

**📖 サブエージェントプロンプトの読み込み**
- `.claude/agents/task/task-modification-analyzer.md` を Read ツールで読み込む
- YAML フロントマターを除外
- 本文のプロンプト内容を取得

**🔨 プロンプトに従った処理の実行**
- 取得したプロンプト内容に記載された手順・指示に従って処理を実行
- ユーザー指示の解析（修正カテゴリ、対象の特定）
- 既存ドキュメント（requirements.md、design.md、GitHub Issue）の確認
- ドキュメント修正の必要性判定
- 修正規模・複雑度の判定（小規模/中規模/大規模）
- 再レビュー/再QA必要性の判定
- 修正方針の提案

**📋 完了報告**
- 「## 📊 修正分析完了」で始まる完了報告を生成
- 分析結果と推奨パイプラインを含む構造化マークダウン形式で出力

**実行パターン**:

**パターンA: executer単独**（小規模・単純な修正）
- 対象: 1-2ファイルの軽微な修正、文言修正、スタイル調整など
- 判定: 再レビュー/再QA不要
- フロー:
  1. ドキュメント更新（analyzer が必要と判定した場合のみ）
  2. `task-executer` のみ実行
- 特徴: 軽微な修正を素早く対応

**パターンB: フルパイプライン**（中規模以上の修正）
- 対象: ロジック変更、新機能追加、複数コンポーネントに影響
- 判定: 再レビュー/再QA必要
- フロー:
  1. ドキュメント更新（analyzer が必要と判定した場合のみ）
  2. `task-executer` → `task-reviewer` → `task-qa` → `task-finisher`
- 特徴: 品質保証のため完全なパイプラインを実行

### 重要事項

#### サブエージェント完了報告の表示
- **各サブエージェント完了後、必ずそのエージェントが生成した完了報告（markdown形式）をそのまま出力してください**
- サブエージェントの報告は「## 🔨 実装フェーズ完了」のような絵文字付き見出しで始まる構造化されたマークダウンです

## 実行例（あくまで一例）

```bash
# 1タスクグループ実行（自動選定）
task-exec #123

# 1タスクグループ実行（明示的指定）
task-exec #123 1.1
task-exec #123 2.3

# Issue番号のみ（#なし）
task-exec 123
task-exec 123 1.1
```

## 注意事項

- GitHub Issueのタスク一覧は特定のフォーマットに従っている必要があります
- 依存関係のあるタスクグループは自動的に順序を考慮して実行されます
- 実行中のタスクグループは他のプロセスと競合しないよう管理されます
- **単一タスクグループ実行**: このコマンドは1タスクグループのみを実行し、完了後にコマンドを終了します
- **複数タスクグループの実行**: 複数のタスクグループを実行したい場合は、このコマンドを繰り返し実行してください
- **追加指示への対応**: コマンド完了後にユーザーから追加の修正や改善の指示があった場合、task-modification-analyzerサブエージェントで修正規模と品質保証の必要性を判定し、適切なパイプライン（executer単独 または フルパイプライン）を推奨します
