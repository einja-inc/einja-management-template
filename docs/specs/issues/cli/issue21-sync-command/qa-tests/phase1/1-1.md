# Phase 1: 基本同期機能 QAテスト結果

## テスト対象ユーザーストーリー
- **Story 1**: 基本的なテンプレート同期（AC1.1-1.3）- P0
- **Story 2**: ディレクトリ分離による管理（AC2.1-2.3）- P0
- **Story 5**: ドライラン機能（AC5.1-5.3）- P0
- **Story 7**: コンフリクト検出と報告（AC7.1-7.3）- P0
- **Story 9**: パッケージ名変更（AC9.1-9.3）- P0
- **実装フェーズ**: Phase 1（2週間）
- **テスター**: TBD
- **最終更新**: TBD

## テストサマリー
| ステータス | 件数 |
|----------|-----|
| ✅ PASS | 0 |
| ❌ FAIL | 0 |
| ⚠️ PARTIAL | 0 |
| 🔄 未実施 | 39 |

---

## 必須自動テスト結果

### 実行コマンド
```bash
# 1. ユニットテスト
pnpm test

# 2. 型チェック（TypeScript）
pnpm typecheck

# 3. Lintチェック
pnpm lint

# 4. ビルドチェック
pnpm build
```

### 結果
| テスト項目 | ステータス | 備考 |
|----------|----------|------|
| ユニットテスト | - | 未実施 |
| 型チェック | - | 未実施 |
| Lintチェック | - | 未実施 |
| ビルドチェック | - | 未実施 |

**重要**: 上記のいずれか1つでも失敗した場合、全体ステータスは**❌ FAIL**となります。

---

## Story 1: 基本的なテンプレート同期

### 受け入れ条件
- **AC1.1**: Given: 既存プロジェクトに`.claude/`, `docs/`が存在する
             When: `npx @einja/cli sync`を実行
             Then: テンプレート最新版との差分がマージされ、成功メッセージが表示される
- **AC1.2**: Given: テンプレート更新がない場合
             When: syncコマンドを実行
             Then: "すでに最新です"とメッセージ表示され、ファイル変更は発生しない
- **AC1.3**: Given: ローカルでカスタマイズしたファイルが存在
             When: テンプレートも同じファイルを更新している
             Then: 3方向マージが実行され、両方の変更が保持される（コンフリクトがない場合）

### テストシナリオ

#### AC1.1: 基本的な同期処理（正常系）

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | テスト用プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | プロジェクトに.claude/, docs/ディレクトリを作成 | ディレクトリ存在 | .claude/, docs/が存在 | - | - |
| 3 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | - | 成功メッセージ表示 | "✅ 同期完了!" が表示される | - | - |
| 5 | ls .claude/commands/einja/ 実行 | ファイル作成確認 | spec-create.md, task-exec.md が存在 | - | - |
| 6 | ls .claude/agents/einja/ 実行 | ファイル作成確認 | spec-requirements.md が存在 | - | - |
| 7 | ls .claude/skills/einja/ 実行 | ファイル作成確認 | スキルファイルが存在 | - | - |
| 8 | ls docs/einja/ 実行 | ファイル作成確認 | acceptance-criteria-and-qa-guide.md が存在 | - | - |
| 9 | cat .einja-sync.json \| jq '.' 実行 | メタデータ生成 | version, lastSync, filesキーが存在 | - | - |
| 10 | cat .einja-sync.json \| jq '.version' 実行 | バージョン確認 | "0.2.0" | - | - |

#### AC1.2: 更新がない場合の処理

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | find .claude/ -newer .einja-sync.json 実行（実行前） | 変更ファイル数 | 0件 | - | 変更前の状態確認 |
| 3 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | - | メッセージ表示 | "すでに最新です" が表示される | - | - |
| 5 | find .claude/ -newer .einja-sync.json 実行（実行後） | ファイル変更なし | 0件 | - | - |
| 6 | cat .einja-sync.json \| jq '.lastSync' 実行 | メタデータ更新 | 最新のタイムスタンプ | - | - |

#### AC1.3: 3方向マージ（コンフリクトなし）

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md の行10を編集 | - | - | - | ローカル変更追加 |
| 3 | テンプレート側の行20を編集（シミュレーション） | - | - | - | テンプレート更新シミュレーション |
| 4 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 5 | - | マージ成功メッセージ | 成功メッセージが表示される | - | - |
| 6 | cat .claude/commands/einja/spec-create.md 実行 | ローカル変更保持 | 行10の変更が保持されている | - | - |
| 7 | - | テンプレート更新適用 | 行20の変更が適用されている | - | - |
| 8 | grep "<<<<<<< LOCAL" .claude/commands/einja/spec-create.md 実行 | コンフリクトマーカーなし | マーカーが存在しない（終了コード1） | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- コマンド出力ログ: `evidence/1-1-sync-output.log`
- メタデータファイル: `evidence/1-1-einja-sync.json`
- 同期後のファイル一覧: `evidence/1-1-file-list.txt`

---

## Story 2: ディレクトリ分離による管理

### 受け入れ条件
- **AC2.1**: Given: 新規プロジェクトで`sync`コマンド実行
             When: 同期処理が完了
             Then: `.claude/commands/einja/`, `.claude/agents/einja/`, `.claude/skills/einja/`, `docs/einja/`にファイルが配置される
- **AC2.2**: Given: `_`プレフィックスのファイル（例: `_custom-agent.md`）が存在
             When: syncコマンドを実行
             Then: `_`プレフィックスファイルはスキップされ、変更されない
- **AC2.3**: Given: `einja/`外のファイル（例: `.claude/commands/my-custom-cmd.md`）が存在
             When: syncコマンドを実行
             Then: `einja/`外のファイルは同期対象外として扱われる

### テストシナリオ

#### AC2.1: einja/サブディレクトリへの配置

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 新規プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 3 | ls -la .claude/commands/ 実行 | サブディレクトリ確認 | einja/ディレクトリが存在 | - | - |
| 4 | ls .claude/commands/einja/ 実行 | ファイル配置 | spec-create.md, task-exec.md等が存在 | - | - |
| 5 | ls .claude/agents/einja/ 実行 | ファイル配置 | spec-requirements.md等が存在 | - | - |
| 6 | ls .claude/skills/einja/ 実行 | ファイル配置 | スキルファイルが存在 | - | - |
| 7 | ls docs/einja/ 実行 | ファイル配置 | acceptance-criteria-and-qa-guide.md等が存在 | - | - |
| 8 | find .claude/ -type f \| grep -v "einja/" 実行 | einja/外のファイルなし | 0件 | - | - |

#### AC2.2: _プレフィックスファイルのスキップ

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/agents/einja/_custom-agent.md を作成 | - | - | - | カスタムファイル作成 |
| 3 | echo "カスタム内容" > .claude/agents/einja/_custom-agent.md 実行 | - | - | - | - |
| 4 | ls -l .claude/agents/einja/_custom-agent.md 実行 | タイムスタンプ記録 | タイムスタンプを記録 | - | 変更前の状態記録 |
| 5 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 6 | ls -l .claude/agents/einja/_custom-agent.md 実行 | タイムスタンプ不変 | タイムスタンプが変更されていない | - | - |
| 7 | cat .claude/agents/einja/_custom-agent.md 実行 | 内容不変 | "カスタム内容"がそのまま残っている | - | - |

#### AC2.3: einja/外のファイルの同期対象外

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/my-custom-cmd.md を作成 | - | - | - | プロジェクト固有ファイル作成 |
| 3 | echo "プロジェクト固有" > .claude/commands/my-custom-cmd.md 実行 | - | - | - | - |
| 4 | ls -l .claude/commands/my-custom-cmd.md 実行 | タイムスタンプ記録 | タイムスタンプを記録 | - | - |
| 5 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 6 | ls -l .claude/commands/my-custom-cmd.md 実行 | タイムスタンプ不変 | タイムスタンプが変更されていない | - | - |
| 7 | cat .claude/commands/my-custom-cmd.md 実行 | 内容不変 | "プロジェクト固有"がそのまま残っている | - | - |
| 8 | cat .einja-sync.json \| jq '.files \| keys' 実行 | メタデータに含まれない | my-custom-cmd.mdがリストに含まれていない | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- ディレクトリ構造: `evidence/2-1-directory-tree.txt`
- カスタムファイル内容: `evidence/2-2-custom-file.md`

---

## Story 5: ドライラン機能

### 受け入れ条件
- **AC5.1**: Given: `--dry-run`オプション指定
             When: syncコマンドを実行
             Then: ファイル変更は発生せず、変更予定のファイル一覧と差分サマリーが表示される
- **AC5.2**: Given: `--dry-run --json`オプション指定
             When: syncコマンドを実行
             Then: JSON形式で差分情報が出力される（CI/CD連携用）
- **AC5.3**: Given: コンフリクトが検出される状況
             When: `--dry-run`を実行
             Then: コンフリクト箇所がハイライト表示され、ファイルパスと行番号が示される

### テストシナリオ

#### AC5.1: ドライランの基本動作

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md を編集 | - | - | - | テストデータ準備 |
| 3 | テンプレート側も更新（シミュレーション） | - | - | - | - |
| 4 | find .claude/ -newer .einja-sync.json 実行（実行前） | 変更ファイル確認 | 1件以上 | - | 実行前の状態確認 |
| 5 | npx @einja/cli sync --dry-run 実行 | コマンド成功 | 終了コード0 | - | - |
| 6 | - | ファイル変更なし | 実行前後でファイルが変更されていない | - | - |
| 7 | - | 差分サマリー表示 | "変更予定のファイル一覧"が表示される | - | - |
| 8 | - | ファイル一覧表示 | .claude/commands/einja/spec-create.md等が表示 | - | - |
| 9 | find .claude/ -newer .einja-sync.json 実行（実行後） | 変更ファイルなし | 実行前と同じ件数 | - | ドライランでファイル変更なし確認 |

#### AC5.2: JSON形式での差分出力

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/task-exec.md を編集 | - | - | - | テストデータ準備 |
| 3 | npx @einja/cli sync --dry-run --json > dry-run.json 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | cat dry-run.json \| jq '.' 実行 | JSON妥当性 | 有効なJSON形式 | - | - |
| 5 | cat dry-run.json \| jq '.status' 実行 | ステータス確認 | "dry_run" | - | - |
| 6 | cat dry-run.json \| jq '.summary' 実行 | サマリー確認 | total, changed等のキーが存在 | - | - |
| 7 | cat dry-run.json \| jq '.files\[\] .path' 実行 | ファイルパス確認 | task-exec.mdが含まれる | - | - |
| 8 | cat dry-run.json \| jq '.files\[\] .action' 実行 | アクション確認 | "merged"等の値が存在 | - | - |

#### AC5.3: コンフリクト箇所のハイライト表示

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md の行10を編集 | - | - | - | ローカル変更 |
| 3 | テンプレート側も同じ行10を異なる内容で編集（シミュレーション） | - | - | - | コンフリクト条件作成 |
| 4 | npx @einja/cli sync --dry-run 実行 | コマンド成功 | 終了コード0 | - | - |
| 5 | - | コンフリクト検出メッセージ | "⚠️ コンフリクトが検出されました"が表示 | - | - |
| 6 | - | ファイルパス表示 | spec-create.mdのパスが表示される | - | - |
| 7 | - | 行番号表示 | 行10が表示される | - | - |
| 8 | - | コンフリクト内容表示 | ローカル版とテンプレート版の差分が表示される | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- ドライラン出力: `evidence/5-1-dry-run-output.log`
- JSON出力: `evidence/5-2-dry-run.json`

---

## Story 7: コンフリクト検出と報告

### 受け入れ条件
- **AC7.1**: Given: ローカルとテンプレートで同じ行を異なる内容で変更
             When: syncコマンドを実行
             Then: コンフリクトマーカー（`<<<<<<< LOCAL`, `=======`, `>>>>>>> TEMPLATE`）が挿入され、ファイルパスが報告される
- **AC7.2**: Given: コンフリクトが検出された
             When: syncコマンドが完了
             Then: 終了コード1で終了し、コンフリクト解消方法のヘルプメッセージが表示される
- **AC7.3**: Given: コンフリクトファイルが存在
             When: 再度syncコマンドを実行
             Then: "未解決のコンフリクトが存在します"とエラー表示され、同期処理がスキップされる

### テストシナリオ

#### AC7.1: コンフリクトマーカーの挿入

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/task-exec.md の行15を"ローカル変更"に編集 | - | - | - | ローカル変更 |
| 3 | テンプレート側も同じ行15を"テンプレート変更"に編集（シミュレーション） | - | - | - | コンフリクト条件作成 |
| 4 | npx @einja/cli sync 実行 | コンフリクト検出 | "⚠️ コンフリクトが検出されました" 表示 | - | - |
| 5 | - | ファイルパス報告 | task-exec.mdのパスが表示される | - | - |
| 6 | cat .claude/commands/einja/task-exec.md 実行 | マーカー挿入確認 | ファイルにマーカーが含まれる | - | - |
| 7 | grep -n "<<<<<<< LOCAL" .claude/commands/einja/task-exec.md 実行 | LOCALマーカー確認 | 行番号とともに表示される | - | - |
| 8 | grep -n "=======" .claude/commands/einja/task-exec.md 実行 | 区切りマーカー確認 | 行番号とともに表示される | - | - |
| 9 | grep -n ">>>>>>> TEMPLATE" .claude/commands/einja/task-exec.md 実行 | TEMPLATEマーカー確認 | 行番号とともに表示される | - | - |

#### AC7.2: 終了コードとヘルプメッセージ

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | AC7.1でコンフリクトが発生した状態 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync; echo $? 実行 | 終了コード確認 | 1 | - | - |
| 3 | npx @einja/cli sync 2>&1 \| grep "解消方法" 実行 | ヘルプメッセージ確認 | コンフリクト解消方法が表示される | - | - |
| 4 | - | 手順説明 | "1. 上記ファイルを開く"等の手順が表示 | - | - |
| 5 | - | マーカー説明 | "<<<<<<< LOCAL と >>>>>>> TEMPLATE"の説明 | - | - |

#### AC7.3: 未解決コンフリクトの検出

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | AC7.1でコンフリクトが発生した状態（未解消） | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync 実行 | エラーメッセージ | "未解決のコンフリクトが存在します" 表示 | - | - |
| 3 | - | ファイルパス表示 | コンフリクトファイルのパスが表示される | - | - |
| 4 | - | 処理スキップ | 同期処理が実行されない | - | - |
| 5 | find .claude/ -newer .einja-sync.json 実行 | ファイル変更なし | 新しいファイルが作成されていない | - | - |
| 6 | コンフリクトマーカーを手動編集して解消 | - | - | - | 解消作業 |
| 7 | npx @einja/cli sync 実行 | 同期成功 | 終了コード0、"✅ 同期完了!" 表示 | - | - |
| 8 | grep "<<<<<<< LOCAL" .claude/commands/einja/task-exec.md 実行 | マーカー削除確認 | マーカーが存在しない（終了コード1） | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- コンフリクトファイル: `evidence/7-1-conflict-file.md`
- コンフリクト出力: `evidence/7-2-conflict-output.log`

---

## Story 9: パッケージ名変更

### 受け入れ条件
- **AC9.1**: Given: 新規インストール
             When: `npx @einja/cli sync`を実行
             Then: コマンドが正常に実行される
- **AC9.2**: Given: package.jsonの`name`フィールド
             When: ファイルを確認
             Then: `"name": "@einja/cli"`と記載されている
- **AC9.3**: Given: 既存の`@einja/claude-cli`ユーザー
             When: `npx @einja/claude-cli`を実行
             Then: 非推奨警告"パッケージ名が変更されました。@einja/cliを使用してください"が表示される

### テストシナリオ

#### AC9.1: 新パッケージ名での実行

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | テスト用プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli --version 実行 | バージョン表示 | バージョン番号が表示される | - | - |
| 3 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | - | 同期処理実行 | "✅ 同期完了!" が表示される | - | - |

#### AC9.2: package.jsonのname確認

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | CLIパッケージのpackage.jsonを確認 | - | - | - | - |
| 2 | cat packages/cli/package.json \| jq '.name' 実行 | パッケージ名確認 | "@einja/cli" | - | - |

#### AC9.3: 旧パッケージ名の非推奨警告

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | テスト用プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | npx @einja/claude-cli sync 実行 | 非推奨警告表示 | "パッケージ名が変更されました"が表示 | - | - |
| 3 | - | 新パッケージ名案内 | "@einja/cliを使用してください"が表示 | - | - |
| 4 | - | コマンド実行 | 警告後に通常通り実行される | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- パッケージ情報: `evidence/9-2-package-json.txt`
- 非推奨警告: `evidence/9-3-deprecation-warning.log`

---

## 統合テスト結果サマリー

### Phase 1全体結果
- **全体ステータス**: 🔄 未実施
- **完了ストーリー**: 0/5（Story 1, 2, 5, 7, 9）
- **テスト合格率**: 0% (0/39)

### 修正が必要な項目
（実施後に記載）

### 次フェーズへの引き継ぎ事項
（実施後に記載）

### 改善提案
（実施後に記載）

---

## 報告と対応

### 失敗原因分類
<!-- 該当する分類にチェック -->
- [ ] **A: 実装ミス** → task-executerへ差し戻し
- [ ] **B: 要件齟齬** → requirements.md修正 → task-executerへ差し戻し
- [ ] **C: 設計不備** → design.md修正 → task-executerへ差し戻し
- [ ] **D: 環境問題** → qa再実行

### task-executerへの差し戻し（該当する場合）
（実施後に記載）

### 修正優先度
（実施後に記載）

### 回避策（該当する場合）
（実施後に記載）
