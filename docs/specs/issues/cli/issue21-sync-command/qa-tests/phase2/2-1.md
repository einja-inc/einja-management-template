# Phase 2: 高度な機能 QAテスト結果

## テスト対象ユーザーストーリー
- **Story 3**: @einja:managedマーカーによるセクション管理（AC3.1-3.3）- P1
- **Story 4**: 選択的同期（AC4.1-4.3）- P1
- **実装フェーズ**: Phase 2（1週間）
- **テスター**: TBD
- **最終更新**: TBD

## テストサマリー
| ステータス | 件数 |
|----------|-----|
| ✅ PASS | 0 |
| ❌ FAIL | 0 |
| ⚠️ PARTIAL | 0 |
| 🔄 未実施 | 17 |

---

## 必須自動テスト結果

### 実行コマンド
```bash
# 1. ユニットテスト
pnpm test

# 2. 型チェック（TypeScript）
pnpm typecheck

# 3. Lintチェック
pnpm lint

# 4. ビルドチェック
pnpm build
```

### 結果
| テスト項目 | ステータス | 備考 |
|----------|----------|------|
| ユニットテスト | - | 未実施 |
| 型チェック | - | 未実施 |
| Lintチェック | - | 未実施 |
| ビルドチェック | - | 未実施 |

**重要**: 上記のいずれか1つでも失敗した場合、全体ステータスは**❌ FAIL**となります。

---

## Story 3: @einja:managedマーカーによるセクション管理

### 受け入れ条件
- **AC3.1**: Given: ファイル内に`<!-- @einja:managed:start -->...<!-- @einja:managed:end -->`セクションが存在
             When: syncコマンドを実行
             Then: マーカー内のセクションはテンプレート版で完全上書きされる
- **AC3.2**: Given: マーカー外のセクションにローカル変更がある
             When: syncコマンドを実行
             Then: マーカー外のセクションは3方向マージが適用され、ローカル変更が保持される
- **AC3.3**: Given: マーカーが正しくペアになっていない（startのみ、endのみ）
             When: syncコマンドを実行
             Then: エラーメッセージが表示され、同期処理がスキップされる

### テストシナリオ

#### AC3.1: マーカー内セクションの完全上書き

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/spec-create.md にマーカー配置 | - | - | - | テストファイル準備 |
| 3 | マーカー内セクションをローカルで編集 | - | - | - | ローカル変更追加 |
| 4 | テンプレート側もマーカー内セクションを更新（シミュレーション） | - | - | - | - |
| 5 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 6 | cat .claude/commands/einja/spec-create.md 実行 | マーカー内上書き確認 | ローカル変更が失われ、テンプレート版になっている | - | - |
| 7 | - | マーカー保持確認 | @einja:managed:startとendが保持されている | - | - |

#### AC3.2: マーカー外セクションの3方向マージ

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/commands/einja/task-exec.md にマーカー配置 | - | - | - | テストファイル準備 |
| 3 | マーカー外セクションをローカルで編集 | - | - | - | ローカル変更追加 |
| 4 | テンプレート側もマーカー外セクションを更新（異なる箇所） | - | - | - | - |
| 5 | npx @einja/cli sync 実行 | コマンド成功 | 終了コード0 | - | - |
| 6 | cat .claude/commands/einja/task-exec.md 実行 | ローカル変更保持 | ローカル変更が保持されている | - | - |
| 7 | - | テンプレート更新適用 | テンプレート更新も適用されている | - | - |
| 8 | - | コンフリクトなし | マーカー外でコンフリクトが発生していない | - | - |

#### AC3.3: 不正なマーカーペアのエラー検出

**ケース1: startマーカーのみ**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/agents/einja/spec-requirements.md にstartマーカーのみ配置 | - | - | - | 不正なマーカー作成 |
| 3 | npx @einja/cli sync 実行 | エラー検出 | 終了コード1 | - | - |
| 4 | - | エラーメッセージ | "対応する@einja:managed:endが見つかりません" 表示 | - | - |
| 5 | - | ファイルパス表示 | spec-requirements.mdのパスが表示 | - | - |
| 6 | - | 行番号表示 | startマーカーの行番号が表示 | - | - |
| 7 | - | 処理スキップ | 同期処理が実行されない | - | - |

**ケース2: endマーカーのみ**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | .claude/agents/einja/spec-requirements.md にendマーカーのみ配置 | - | - | - | 不正なマーカー作成 |
| 3 | npx @einja/cli sync 実行 | エラー検出 | 終了コード1 | - | - |
| 4 | - | エラーメッセージ | "対応する@einja:managed:startが見つかりません" 表示 | - | - |
| 5 | - | ファイルパス表示 | spec-requirements.mdのパスが表示 | - | - |
| 6 | - | 行番号表示 | endマーカーの行番号が表示 | - | - |

**ケース3: マーカーの修正後の再実行**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | AC3.3ケース1の不正なマーカー状態 | - | - | - | テスト環境準備 |
| 2 | endマーカーを追加してペアを正しくする | - | - | - | マーカー修正 |
| 3 | npx @einja/cli sync 実行 | 同期成功 | 終了コード0、"✅ 同期完了!" 表示 | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- マーカー付きファイル: `evidence/3-1-managed-file.md`
- マーカーエラー出力: `evidence/3-3-marker-error.log`

---

## Story 4: 選択的同期

### 受け入れ条件
- **AC4.1**: Given: `--only commands,agents`オプション指定
             When: syncコマンドを実行
             Then: `.claude/commands/einja/`, `.claude/agents/einja/`のみ同期され、skills, docsはスキップされる
- **AC4.2**: Given: `--only skills`オプション指定
             When: syncコマンドを実行
             Then: `.claude/skills/einja/`のみ同期され、他のカテゴリはスキップされる
- **AC4.3**: Given: 無効なカテゴリ名（例: `--only invalid-category`）を指定
             When: syncコマンドを実行
             Then: エラーメッセージ"無効なカテゴリ: invalid-category"が表示され、有効なカテゴリ一覧が提示される

### テストシナリオ

#### AC4.1: 複数カテゴリの選択的同期

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | 全カテゴリのファイルを編集（commands, agents, skills, docs） | - | - | - | テストデータ準備 |
| 3 | ls -l .claude/commands/einja/ 実行 | タイムスタンプ記録 | commandsのタイムスタンプを記録 | - | 実行前の状態記録 |
| 4 | ls -l .claude/agents/einja/ 実行 | タイムスタンプ記録 | agentsのタイムスタンプを記録 | - | - |
| 5 | ls -l .claude/skills/einja/ 実行 | タイムスタンプ記録 | skillsのタイムスタンプを記録 | - | - |
| 6 | ls -l docs/einja/ 実行 | タイムスタンプ記録 | docsのタイムスタンプを記録 | - | - |
| 7 | npx @einja/cli sync --only commands,agents 実行 | コマンド成功 | 終了コード0 | - | - |
| 8 | - | 選択的同期メッセージ | "commandsとagentsのみ同期します"等のメッセージ | - | - |
| 9 | ls -l .claude/commands/einja/ 実行 | タイムスタンプ更新 | commandsのタイムスタンプが更新されている | - | - |
| 10 | ls -l .claude/agents/einja/ 実行 | タイムスタンプ更新 | agentsのタイムスタンプが更新されている | - | - |
| 11 | ls -l .claude/skills/einja/ 実行 | タイムスタンプ不変 | skillsのタイムスタンプが変更されていない | - | スキップ確認 |
| 12 | ls -l docs/einja/ 実行 | タイムスタンプ不変 | docsのタイムスタンプが変更されていない | - | スキップ確認 |

#### AC4.2: 単一カテゴリの選択的同期

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | 同期済みプロジェクトを準備 | - | - | - | テスト環境準備 |
| 2 | 全カテゴリのファイルを編集 | - | - | - | テストデータ準備 |
| 3 | npx @einja/cli sync --only skills 実行 | コマンド成功 | 終了コード0 | - | - |
| 4 | - | 選択的同期メッセージ | "skillsのみ同期します"等のメッセージ | - | - |
| 5 | ls -l .claude/skills/einja/ 実行 | タイムスタンプ更新 | skillsのタイムスタンプが更新されている | - | - |
| 6 | ls -l .claude/commands/einja/ 実行 | タイムスタンプ不変 | commandsのタイムスタンプが変更されていない | - | スキップ確認 |
| 7 | ls -l .claude/agents/einja/ 実行 | タイムスタンプ不変 | agentsのタイムスタンプが変更されていない | - | スキップ確認 |
| 8 | ls -l docs/einja/ 実行 | タイムスタンプ不変 | docsのタイムスタンプが変更されていない | - | スキップ確認 |

#### AC4.3: 無効なカテゴリのエラー表示

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | テスト用プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --only invalid-category 実行 | エラー検出 | 終了コード1 | - | - |
| 3 | - | エラーメッセージ | "無効なカテゴリ: invalid-category" 表示 | - | - |
| 4 | - | 有効なカテゴリ一覧 | "commands, agents, skills, docs"が表示 | - | - |
| 5 | - | 処理スキップ | 同期処理が実行されない | - | - |

**ケース2: 複数の無効なカテゴリ**

| No | 手順 | 確認項目 | 期待値 | 結果 | 備考 |
|----|------|---------|--------|------|------|
| 1 | テスト用プロジェクトディレクトリ作成 | - | - | - | テスト環境準備 |
| 2 | npx @einja/cli sync --only commands,invalid1,invalid2 実行 | エラー検出 | 終了コード1 | - | - |
| 3 | - | エラーメッセージ | "無効なカテゴリ: invalid1, invalid2" 表示 | - | - |
| 4 | - | 有効なカテゴリ一覧 | "commands, agents, skills, docs"が表示 | - | - |

### 全体ステータス: 🔄 未実施

#### 主な問題点
（実施後に記載）

#### 対応策
（実施後に記載）

#### エビデンス
- 選択的同期出力: `evidence/4-1-selective-sync.log`
- カテゴリエラー出力: `evidence/4-3-category-error.log`

---

## 統合テスト結果サマリー

### Phase 2全体結果
- **全体ステータス**: 🔄 未実施
- **完了ストーリー**: 0/2（Story 3, 4）
- **テスト合格率**: 0% (0/17)

### 修正が必要な項目
（実施後に記載）

### 次フェーズへの引き継ぎ事項
（実施後に記載）

### 改善提案
（実施後に記載）

---

## 報告と対応

### 失敗原因分類
<!-- 該当する分類にチェック -->
- [ ] **A: 実装ミス** → task-executerへ差し戻し
- [ ] **B: 要件齟齬** → requirements.md修正 → task-executerへ差し戻し
- [ ] **C: 設計不備** → design.md修正 → task-executerへ差し戻し
- [ ] **D: 環境問題** → qa再実行

### task-executerへの差し戻し（該当する場合）
（実施後に記載）

### 修正優先度
（実施後に記載）

### 回避策（該当する場合）
（実施後に記載）
