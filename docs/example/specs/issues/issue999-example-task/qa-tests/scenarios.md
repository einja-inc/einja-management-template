# シナリオテスト

## 概要
このファイルは、複数タスクをまたぐ継続操作のシナリオテストを定義します。
各タスク完了後に、該当するシナリオテストを実行してください。

---

## シナリオ1: マジックリンク認証フロー

### 目的
ユーザーがメールアドレスを入力してマジックリンクをリクエストし、メール内のリンクをクリックしてログイン完了までの一連のフローを検証する。

### 関連
- **受け入れ条件**: AC1.1, AC1.2, AC1.3, AC1.4
- **関連タスク**: 1.1.1, 1.1.2, 1.1.3, 2.1.1

### 実施タイミング
- **タスク1.1.3完了後**: Step 1-4まで（部分実行：API認証まで）
- **タスク2.1.5完了後**: 全Step（フル実行：UI実装完了）
- **タスク2.1.8完了後**: 全Step（リグレッション：Phase 2完了確認）

### テスト手順

| Step | 操作 | 確認項目 | 期待値 | 結果 |
|------|------|---------|--------|------|
| 1 | ログイン画面に移動 | 画面が表示される | メールアドレス入力フォームが表示される | - |
| 2 | メールアドレス入力: test@example.com | - | - | - |
| 3 | 送信ボタンをクリック | ローディング状態になる | ボタン無効化、スピナー表示 | - |
| 4 | - | API呼び出しが成功 | メール送信確認画面に遷移 | - |
| 5 | - | 送信先アドレスが表示される | test@example.comが表示 | - |
| 6 | 受信したメールのリンクをクリック | トークン検証画面に遷移 | ローディングスピナー表示 | - |
| 7 | - | 認証処理が完了 | ダッシュボードにリダイレクト | - |
| 8 | - | ログイン状態になる | ユーザー名またはアバターが表示される | - |

### 実行ログ
（実施後に記載）

---

## シナリオ2: プロフィール取得・更新フロー

### 目的
認証済みユーザーが自身のプロフィールを取得し、更新できることを検証する。

### 関連
- **受け入れ条件**: AC2.1, AC2.2
- **関連タスク**: 1.2.1, 1.2.2

### 実施タイミング
- **タスク1.2.1完了後**: Step 1-2まで（部分実行：取得APIのみ）
- **タスク1.2.2完了後**: 全Step（フル実行：プロフィールAPI実装完了）
- **タスク2.1.8完了後**: 全Step（リグレッション：認証UI変更の影響確認）

### テスト手順

| Step | 操作 | 確認項目 | 期待値 | 結果 |
|------|------|---------|--------|------|
| 1 | シナリオ1を実行してログイン状態にする | ログイン済み | ダッシュボードが表示される | - |
| 2 | GET /api/users/me を呼び出す | プロフィール取得 | 現在のプロフィール情報がJSON形式で返る | - |
| 3 | PUT /api/users/profile でbioを更新 | 更新成功 | 200 OK、更新後のデータが返る | - |
| 4 | GET /api/users/me を再度呼び出す | 更新が反映されている | bioフィールドが新しい値になっている | - |

### 実行ログ
（実施後に記載）

---

## シナリオ3: エラーハンドリングフロー

### 目的
各種エラーケース（無効なメールアドレス、期限切れトークン、使用済みトークン等）が適切にハンドリングされることを検証する。

### 関連
- **受け入れ条件**: AC1.2, AC1.3
- **関連タスク**: 1.1.2, 1.1.3, 2.1.1

### 実施タイミング
- **タスク1.1.3完了後**: Step 1-4まで（部分実行：APIエラーハンドリング）
- **タスク2.1.4完了後**: 全Step（フル実行：UIエラー表示含む）
- **タスク2.1.8完了後**: 全Step（リグレッション：Phase 2完了確認）

### テスト手順

| Step | 操作 | 確認項目 | 期待値 | 結果 |
|------|------|---------|--------|------|
| 1 | ログイン画面で空欄のまま送信 | バリデーションエラー | 「メールアドレスを入力してください」表示 | - |
| 2 | 不正な形式（test@）で送信 | バリデーションエラー | 「有効なメールアドレスを入力してください」表示 | - |
| 3 | 有効なメールで送信後、1分以内に再送信 | レート制限エラー | 429エラー、待機時間が表示される | - |
| 4 | 期限切れトークンでアクセス | 期限切れエラー | 「リンクの有効期限が切れています」表示 | - |
| 5 | 使用済みトークンで再アクセス | 使用済みエラー | 「このリンクは既に使用されています」表示 | - |
| 6 | 無効なトークンでアクセス | 無効エラー | 「無効なリンクです」表示 | - |

### 実行ログ
（実施後に記載）

---

## シナリオ4: セキュリティ通知フロー

### 目的
新しいデバイスからログインした際にセキュリティ通知が送信され、セッション無効化ができることを検証する。

### 関連
- **受け入れ条件**: AC3.1, AC3.2（Story 3に対応）
- **関連タスク**: 3.1.1, 3.1.2, 3.1.3

### 実施タイミング
- **タスク3.1.2完了後**: Step 1-3まで（部分実行：通知送信まで）
- **タスク3.1.3完了後**: 全Step（フル実行：セッション無効化含む）
- **タスク3.1.5完了後**: 全Step（リグレッション：Phase 3完了確認）

### テスト手順

| Step | 操作 | 確認項目 | 期待値 | 結果 |
|------|------|---------|--------|------|
| 1 | 新しいデバイス（別ブラウザ）でログイン | ログイン成功 | ダッシュボードに遷移 | - |
| 2 | - | セキュリティ通知メール受信 | 新規デバイスログインの通知メールが届く | - |
| 3 | ダッシュボード確認 | 通知バナー表示 | 「新しいデバイスからのログインを検出しました」 | - |
| 4 | メール内「セッション無効化」リンクをクリック | 確認画面表示 | 「このセッションを無効化しますか？」表示 | - |
| 5 | 「無効化する」ボタンをクリック | セッション無効化 | 「セッションを無効化しました」表示 | - |
| 6 | 無効化されたデバイスでページをリロード | ログアウト状態 | ログイン画面にリダイレクト | - |

### 実行ログ
（実施後に記載）
