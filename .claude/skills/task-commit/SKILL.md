---
name: task-commit
description: "コミット・プッシュを実行するSkill。docs/github-workflow.mdcのルールに従い、分割コミットを実施"
allowed-tools:
  - Bash
  - Read
  - Glob
  - Grep
  - AskUserQuestion
  - TodoWrite
  - TodoRead
---

# task-commit Skill: コミット・プッシュ実行エンジン

## 役割

変更をコミット・プッシュします。`docs/github-workflow.mdc` のコミットルールに厳格に従い、適切な粒度でコミットを分割します。

## 入力パラメータ

- `skip_quality_check`: boolean（省略可能）
  - `true`: 品質チェック（lint/typecheck/test/build）をスキップ
  - `false`または省略: 品質チェックを実行

task-qaから呼び出された場合は `skip_quality_check=true` が渡されます。

---

## 実行手順（6ステップ）

### ステップ1: 変更確認

1. `git status` で変更ファイルを確認
2. `git diff` で差分内容を確認
3. **変更がない場合**: 以下を出力して正常終了

```markdown
## 🚀 コミット・プッシュ完了

### ステータス: ✅ SUCCESS（変更なし）

コミット対象の変更がありませんでした。
```

---

### ステップ2: 最新化

1. `git pull --rebase` を実行して最新化
2. **コンフリクト発生時**: 以下を出力して終了

```markdown
## 🚀 コミット・プッシュ

### ステータス: ❌ FAILURE

**エラー**: git pull --rebase でコンフリクトが発生しました。

手動でコンフリクトを解決してください。

\`\`\`
[コンフリクト詳細]
\`\`\`
```

---

### ステップ3: コミット分割方針の決定

**⚠️ 重要**: `docs/github-workflow.mdc` の「コミットの分割方針」を**必ず**参照すること。

#### 分割基準

以下の場合は**必ず別々のコミットに分割**:

1. **異なる目的や種類の変更**
   - ソースコードの変更とドキュメントの更新
   - 機能追加と設定ファイルの変更
   - リファクタリングとバグ修正

2. **異なるコンポーネントやモジュールの変更**
   - 複数のマイクロサービスやコンポーネントの変更
   - フロントエンドとバックエンドの変更

3. **レビューの容易さを考慮した分割**
   - 大規模な変更は小さな論理的なまとまりに分割
   - テストコードの追加・更新は実装とは別のコミット

#### ユーザーへの確認

**AskUserQuestion**を使用して、以下の形式でユーザーに分割案を提示し合意を取得:

```
コミット分割案を提案します。

### 分割案

| # | 種類 | コミットメッセージ | 対象ファイル |
|---|------|------------------|-------------|
| 1 | feat | feat: ユーザー認証機能の追加 | src/auth/*.ts |
| 2 | test | test: 認証機能のテスト追加 | src/auth/*.test.ts |
| 3 | docs | docs: 認証機能のドキュメント更新 | docs/*.md |

この分割案でよろしいですか？修正が必要な場合はお知らせください。
```

---

### ステップ4: 品質チェック（条件付き）

#### `skip_quality_check=true` の場合
- スキップして次のステップへ

#### `skip_quality_check=false` または省略の場合

以下のコマンドを順次実行:

```bash
pnpm lint
pnpm typecheck
pnpm test
pnpm build
```

**失敗時**: 以下を出力して終了（コミットしない）

```markdown
## 🚀 コミット・プッシュ

### ステータス: ❌ FAILURE

**エラー**: 品質チェックに失敗しました。

\`\`\`
[エラー詳細]
\`\`\`

問題を修正してから再度実行してください。
```

---

### ステップ5: コミット実行

合意した分割方針に従って順次コミットを実行。

#### コミットメッセージ形式

`docs/github-workflow.mdc` に従い:

- **プレフィックス**: `feat:`, `fix:`, `docs:`, `style:`, `refactor:`, `test:`, `chore:`
- **言語**: 日本語
- **形式**: 1行目に概要、2行目以降に詳細

#### コミットコマンド例

```bash
git add src/auth/login.ts src/auth/logout.ts

git commit -m "$(cat <<'EOF'
feat: ユーザー認証機能の追加

- JWT認証の実装
- ログイン・ログアウトエンドポイントの追加
- 認証ミドルウェアの実装
EOF
)"
```

---

### ステップ6: プッシュ実行

1. `git push` を実行
2. 結果を出力

---

## 出力形式

### 成功時

```markdown
## 🚀 コミット・プッシュ完了

### コミットサマリー
- **コミット数**: {count}個
- **変更ファイル数**: {files}個

### コミット一覧
| # | メッセージ | ファイル数 |
|---|----------|----------|
| 1 | feat: ユーザー認証機能の追加 | 3 |
| 2 | test: 認証機能のテスト追加 | 2 |

### プッシュ結果
\`\`\`
[git push の出力]
\`\`\`

### ステータス: ✅ SUCCESS
```

### 失敗時

```markdown
## 🚀 コミット・プッシュ

### ステータス: ❌ FAILURE

**エラー**: [エラーの種類]

\`\`\`
[エラー詳細]
\`\`\`

[推奨される対処方法]
```

---

## エラーハンドリング

| エラー種別 | 対処 |
|-----------|------|
| git pull コンフリクト | 報告して終了、手動解決を依頼 |
| 品質チェック失敗 | 報告して終了、修正を依頼 |
| git commit 失敗 | エラー内容を報告 |
| git push 失敗 | エラー内容を報告、原因を説明 |

---

## 参考資料

- `docs/github-workflow.mdc` - コミットルール、分割方針、メッセージ形式の詳細

---

**最終更新**: 2025-01-04
